<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 IPTW | 직업환경보건 연구방법론</title>
  <meta name="description" content="직업환경보건 연구에서 필요한 연구방법론 정리." />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 IPTW | 직업환경보건 연구방법론" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="직업환경보건 연구에서 필요한 연구방법론 정리." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 IPTW | 직업환경보건 연구방법론" />
  
  <meta name="twitter:description" content="직업환경보건 연구에서 필요한 연구방법론 정리." />
  

<meta name="author" content="윤진하" />


<meta name="date" content="2021-08-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="mixed-model.html"/>
<link rel="next" href="covid-data-step.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> 소개</a></li>
<li class="chapter" data-level="2" data-path="직업병-연구방법론.html"><a href="직업병-연구방법론.html"><i class="fa fa-check"></i><b>2</b> 직업병 연구방법론</a></li>
<li class="chapter" data-level="3" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html"><i class="fa fa-check"></i><b>3</b> Time series data analysis, regression</a>
<ul>
<li class="chapter" data-level="3.1" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#introduction"><i class="fa fa-check"></i><b>3.1</b> introduction</a></li>
<li class="chapter" data-level="3.2" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#a-case-study-in-air-pollution-and-health"><i class="fa fa-check"></i><b>3.2</b> A case study in Air Pollution and Health</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#starting-up"><i class="fa fa-check"></i><b>3.2.1</b> Starting Up</a></li>
<li class="chapter" data-level="3.2.2" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#statistical-issues-in-estimating-the-health-effects-of-spatialtemporal-environmental-exposures"><i class="fa fa-check"></i><b>3.2.2</b> Statistical Issues in Estimating the Health Effects of Spatial–Temporal Environmental Exposures</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#simulation-study-for-pm10-and-cvd-mortality"><i class="fa fa-check"></i><b>3.3</b> simulation study for pm10 and cvd mortality</a></li>
<li class="chapter" data-level="3.4" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#case-study-influenza-epidemic-and-suicide"><i class="fa fa-check"></i><b>3.4</b> case study: influenza epidemic and suicide</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#실습-데이터"><i class="fa fa-check"></i><b>3.4.1</b> 실습 데이터</a></li>
<li class="chapter" data-level="3.4.2" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#simple-time-related-variable-adjusting-regression"><i class="fa fa-check"></i><b>3.4.2</b> simple time-related variable adjusting regression</a></li>
<li class="chapter" data-level="3.4.3" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#arima"><i class="fa fa-check"></i><b>3.4.3</b> ARIMA</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#analysis-and-forecasting-regression"><i class="fa fa-check"></i><b>3.5</b> analysis and forecasting, regression</a></li>
<li class="chapter" data-level="3.6" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#arima-1"><i class="fa fa-check"></i><b>3.6</b> ARIMA</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#arima-감기-자살-aic"><i class="fa fa-check"></i><b>3.6.1</b> arima 감기 자살 , AIC</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#aic-bic-in-generalize-additive-model"><i class="fa fa-check"></i><b>3.7</b> AIC BIC in generalize additive model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="nested-case-control-study.html"><a href="nested-case-control-study.html"><i class="fa fa-check"></i><b>4</b> Nested Case Control Study</a>
<ul>
<li class="chapter" data-level="4.1" data-path="nested-case-control-study.html"><a href="nested-case-control-study.html#simple-tutor-for-nested-case-control-ncc-study"><i class="fa fa-check"></i><b>4.1</b> simple tutor for nested case control (NCC) study</a></li>
<li class="chapter" data-level="4.2" data-path="nested-case-control-study.html"><a href="nested-case-control-study.html#sampling-schemes-for-nested-case-control-studies"><i class="fa fa-check"></i><b>4.2</b> Sampling schemes for nested case-control studies</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="survival-data.html"><a href="survival-data.html"><i class="fa fa-check"></i><b>5</b> Survival Data</a>
<ul>
<li class="chapter" data-level="5.1" data-path="survival-data.html"><a href="survival-data.html#cox-proportional"><i class="fa fa-check"></i><b>5.1</b> Cox Proportional</a></li>
<li class="chapter" data-level="5.2" data-path="survival-data.html"><a href="survival-data.html#non-proportional-model"><i class="fa fa-check"></i><b>5.2</b> non-proportional model</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="survival-data.html"><a href="survival-data.html#log-rank-test"><i class="fa fa-check"></i><b>5.2.1</b> log-rank test</a></li>
<li class="chapter" data-level="5.2.2" data-path="survival-data.html"><a href="survival-data.html#python-tutor-윤동규"><i class="fa fa-check"></i><b>5.2.2</b> python tutor 윤동규</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mixed-model.html"><a href="mixed-model.html"><i class="fa fa-check"></i><b>6</b> Mixed Model</a>
<ul>
<li class="chapter" data-level="6.1" data-path="mixed-model.html"><a href="mixed-model.html#introduction-1"><i class="fa fa-check"></i><b>6.1</b> introduction</a></li>
<li class="chapter" data-level="6.2" data-path="mixed-model.html"><a href="mixed-model.html#data-step-1"><i class="fa fa-check"></i><b>6.2</b> data step 1</a></li>
<li class="chapter" data-level="6.3" data-path="mixed-model.html"><a href="mixed-model.html#data-analysis-start"><i class="fa fa-check"></i><b>6.3</b> Data analysis start</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="mixed-model.html"><a href="mixed-model.html#job-loss-due-to-covid19-psychological-aggravation-according-to-gender"><i class="fa fa-check"></i><b>6.3.1</b> job loss due to COVID19, psychological aggravation according to Gender</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="iptw.html"><a href="iptw.html"><i class="fa fa-check"></i><b>7</b> IPTW</a>
<ul>
<li class="chapter" data-level="7.1" data-path="iptw.html"><a href="iptw.html#package-tutorial"><i class="fa fa-check"></i><b>7.1</b> package tutorial</a></li>
<li class="chapter" data-level="7.2" data-path="iptw.html"><a href="iptw.html#case-study-of-noise-exposure-and-hypertension"><i class="fa fa-check"></i><b>7.2</b> case study of noise exposure and hypertension</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="covid-data-step.html"><a href="covid-data-step.html"><i class="fa fa-check"></i><b>8</b> covid data step</a>
<ul>
<li class="chapter" data-level="8.1" data-path="covid-data-step.html"><a href="covid-data-step.html#load-data-of-int-and-kr"><i class="fa fa-check"></i><b>8.1</b> load data of Int and Kr</a></li>
<li class="chapter" data-level="8.2" data-path="covid-data-step.html"><a href="covid-data-step.html#data-merge"><i class="fa fa-check"></i><b>8.2</b> data merge</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html"><i class="fa fa-check"></i><b>9</b> 산업보건분야에서 건강보험공단 자료 분석</a>
<ul>
<li class="chapter" data-level="9.1" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html#빅데이터-위원회"><i class="fa fa-check"></i><b>9.1</b> 빅데이터 위원회</a></li>
<li class="chapter" data-level="9.2" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html#직업환경분야-건강보험공단-자료-분석"><i class="fa fa-check"></i><b>9.2</b> 직업환경분야 건강보험공단 자료 분석</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html#건강보험공단-자료-및-사용"><i class="fa fa-check"></i><b>9.2.1</b> 건강보험공단 자료 및 사용</a></li>
<li class="chapter" data-level="9.2.2" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html#건강보험공단-자료-분석-방법"><i class="fa fa-check"></i><b>9.2.2</b> 건강보험공단 자료 분석 방법</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">직업환경보건 연구방법론</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="iptw" class="section level1" number="7">
<h1><span class="header-section-number">Chapter 7</span> IPTW</h1>
<p>Summary of <code>TWANG packages</code>’s tutorial of <a href="https://cran.r-project.org/web/packages/twang/vignettes/iptw.pdf" class="uri">https://cran.r-project.org/web/packages/twang/vignettes/iptw.pdf</a>
Always thanks to researcher for making such nice tutorial for me!!!. Now, I use Korean for me haha</p>
<div id="package-tutorial" class="section level2" number="7.1">
<h2><span class="header-section-number">7.1</span> package tutorial</h2>
<p><code>twang, survey</code> 라이브러리를 불러옴.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="iptw.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb3-2"><a href="iptw.html#cb3-2" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;twang&quot;</span>, <span class="st">&quot;survey&quot;</span>,<span class="st">&quot;tidyverse&quot;</span>)</span>
<span id="cb3-3"><a href="iptw.html#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (pkg <span class="cf">in</span> pkgs) {</span>
<span id="cb3-4"><a href="iptw.html#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (pkg <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()) <span class="sc">==</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-5"><a href="iptw.html#cb3-5" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">eval</span>( <span class="fu">bquote</span>(<span class="fu">install.packages</span>(.(pkg))) )}</span>
<span id="cb3-6"><a href="iptw.html#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> </span>
<span id="cb3-7"><a href="iptw.html#cb3-7" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">eval</span>(<span class="fu">bquote</span>(<span class="fu">library</span>(.(pkg))))}  </span>
<span id="cb3-8"><a href="iptw.html#cb3-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p>실습데이터 <code>iptwExWide</code>를 불러옴.</p>
</blockquote>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="iptw.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;iptwExWide&quot;</span>)</span></code></pre></div>
<p><code>Time varying value(TV)</code>와 Treatment가 있고 서로 상관이 있는 상태에서 outcome을 예측해 봅니다. 이때 시간 <span class="math inline">\(t_i\)</span> 가 <span class="math inline">\(t_{i+1}\)</span>에 영향을 미친다고 가정하면, <code>use0</code>로 인해 <code>tx1</code>이 바뀔수 있는 상태입니다. 즉 <span class="math inline">\(Outcome_i \sim \beta_1 T_i + \beta_2 U_i + \epsilon\)</span> 으로 예측하면 <span class="math inline">\(T_i \sim U_i\)</span> 라는, 즉 쓸만해서 약을 썼다는 것을 조절하지 못하게 됩니다. 따라서 쓸만해서 약을 쓰는 사람 중 비슷한 사람을 매칭하는 방법을 사용할 수 있습니다. 이때 <code>propensity score matching</code>방법을 이용하여 계산된 <code>weighting</code> 값을 이용해서 컨트롤 해주겠다는 의미 정도입니다.</p>
<p>첫 baseline 을 <code>t = 0</code>로 하고 3번 추적되었다고 하면 아래와 같이 식을 만들수 있습니다.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="iptw.html#cb5-1" aria-hidden="true" tabindex="-1"></a>iptw.Ex1 <span class="ot">&lt;-</span> <span class="fu">iptw</span>(<span class="fu">list</span>(tx1 <span class="sc">~</span> use0 <span class="sc">+</span> gender <span class="sc">+</span> age,</span>
<span id="cb5-2"><a href="iptw.html#cb5-2" aria-hidden="true" tabindex="-1"></a> tx2 <span class="sc">~</span> use1 <span class="sc">+</span> use0 <span class="sc">+</span> tx1 <span class="sc">+</span> gender <span class="sc">+</span> age,</span>
<span id="cb5-3"><a href="iptw.html#cb5-3" aria-hidden="true" tabindex="-1"></a> tx3 <span class="sc">~</span> use2 <span class="sc">+</span> use1 <span class="sc">+</span> use0 <span class="sc">+</span> tx2 <span class="sc">+</span> tx1 <span class="sc">+</span> gender <span class="sc">+</span> age),</span>
<span id="cb5-4"><a href="iptw.html#cb5-4" aria-hidden="true" tabindex="-1"></a> timeInvariant <span class="sc">~</span> gender <span class="sc">+</span> age,</span>
<span id="cb5-5"><a href="iptw.html#cb5-5" aria-hidden="true" tabindex="-1"></a> <span class="at">data =</span> iptwExWide,</span>
<span id="cb5-6"><a href="iptw.html#cb5-6" aria-hidden="true" tabindex="-1"></a> <span class="at">cumulative =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-7"><a href="iptw.html#cb5-7" aria-hidden="true" tabindex="-1"></a> <span class="at">priorTreatment =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-8"><a href="iptw.html#cb5-8" aria-hidden="true" tabindex="-1"></a> <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-9"><a href="iptw.html#cb5-9" aria-hidden="true" tabindex="-1"></a> <span class="at">stop.method =</span> <span class="st">&quot;es.max&quot;</span>,</span>
<span id="cb5-10"><a href="iptw.html#cb5-10" aria-hidden="true" tabindex="-1"></a> <span class="at">n.trees =</span> <span class="dv">5000</span>)</span></code></pre></div>
<p>이제 weighting 을 구하고 이용하여 Treatment effect를 산출해 보겠습니다. 이게 무슨 뜻일까?(20120707) " Because the weights often have
substantial variation, the weights are commonly stabilized where the standard inverse probability
of treatment weights are multiplied by the estimated probability of receiving the treatment that
each individual received, conditioning only on previous periods’ treatment indicators."</p>
<p>우선 표준화된 가중치를 구하고, 이후 이전 treatment가 지금의 treatment에 주는 영향을 고려한 값을 곱해서 stablized weights 를 산출한다는 뜻인듯.</p>
<p>우선 number of periods of treatment 가 outcome에 영향을 준다고 가정하고 통계를 돌려보자. 그렇다면, nTx가 outcome에 영향을 미치는데, 이때 iptw을 이용한 가중치를 보정해 주는 것. 이때 conditional regression 이 필요한데, 가중치와 id(cluster)등은 <code>survey</code> package의 <code>svydesign, svyglm</code>을 이용하여 컨트롤함.
먼저 standardized weight를 구함. 이때 <code>get.weights.unstab</code> 함수로 <code>iptw.Ex1</code>에서 3 시간 포인트 별로 구했던 값을 이용하여 가중치를 산출(원리에 대해서는 논문 읽기).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="iptw.html#cb6-1" aria-hidden="true" tabindex="-1"></a>unstabWt1 <span class="ot">&lt;-</span> <span class="fu">get.weights.unstab</span>(iptw.Ex1)</span>
<span id="cb6-2"><a href="iptw.html#cb6-2" aria-hidden="true" tabindex="-1"></a>nTx <span class="ot">&lt;-</span> <span class="fu">with</span>(iptwExWide, tx1 <span class="sc">+</span> tx2 <span class="sc">+</span> tx3)</span>
<span id="cb6-3"><a href="iptw.html#cb6-3" aria-hidden="true" tabindex="-1"></a>outDatUnstab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">outcome =</span> iptwExWide<span class="sc">$</span>outcome,</span>
<span id="cb6-4"><a href="iptw.html#cb6-4" aria-hidden="true" tabindex="-1"></a> nTx,</span>
<span id="cb6-5"><a href="iptw.html#cb6-5" aria-hidden="true" tabindex="-1"></a> <span class="at">wt =</span> unstabWt1<span class="sc">$</span>es.max.ATE)</span>
<span id="cb6-6"><a href="iptw.html#cb6-6" aria-hidden="true" tabindex="-1"></a>sv1unstab <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="sc">~</span><span class="dv">1</span>, <span class="at">weights =</span> <span class="sc">~</span>wt, <span class="at">data =</span> outDatUnstab)</span>
<span id="cb6-7"><a href="iptw.html#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="iptw.html#cb6-8" aria-hidden="true" tabindex="-1"></a>fitUnstab <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(outcome <span class="sc">~</span> nTx, sv1unstab)</span>
<span id="cb6-9"><a href="iptw.html#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(fitUnstab)</span></code></pre></div>
<pre><code>## (Intercept)         nTx 
##  0.08325034 -0.12798336</code></pre>
<p>이때 nTx 에 따라 -0.12798 의 <span class="math inline">\(\beta\)</span> 값이 나타남.
이제 여기의 weight 값에 이전 treatment가 지금의 treatment에 주는 영향을 고려한 값을 곱해서 stablized weights 를 산출함.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="iptw.html#cb8-1" aria-hidden="true" tabindex="-1"></a>fitList <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">glm</span>(tx1 <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> binomial, <span class="at">data =</span> iptwExWide),</span>
<span id="cb8-2"><a href="iptw.html#cb8-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">glm</span>(tx2 <span class="sc">~</span> tx1, <span class="at">family =</span> binomial, <span class="at">data =</span> iptwExWide),</span>
<span id="cb8-3"><a href="iptw.html#cb8-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">glm</span>(tx3 <span class="sc">~</span> tx1 <span class="sc">+</span> tx2, <span class="at">family =</span> binomial, <span class="at">data =</span> iptwExWide))</span>
<span id="cb8-4"><a href="iptw.html#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="iptw.html#cb8-5" aria-hidden="true" tabindex="-1"></a>numWt <span class="ot">&lt;-</span> <span class="fu">get.weights.num</span>(iptw.Ex1, fitList)</span>
<span id="cb8-6"><a href="iptw.html#cb8-6" aria-hidden="true" tabindex="-1"></a>stabWt1 <span class="ot">&lt;-</span> unstabWt1 <span class="sc">*</span> numWt</span>
<span id="cb8-7"><a href="iptw.html#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="iptw.html#cb8-8" aria-hidden="true" tabindex="-1"></a>outDatStab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">outcome =</span> iptwExWide<span class="sc">$</span>outcome,</span>
<span id="cb8-9"><a href="iptw.html#cb8-9" aria-hidden="true" tabindex="-1"></a> nTx,</span>
<span id="cb8-10"><a href="iptw.html#cb8-10" aria-hidden="true" tabindex="-1"></a> <span class="at">wt =</span> stabWt1<span class="sc">$</span>es.max.ATE)</span></code></pre></div>
<p>이제 survey 방식으로 회귀분석을 하고 해석하면 됨.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="iptw.html#cb9-1" aria-hidden="true" tabindex="-1"></a>sv1stab <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="sc">~</span><span class="dv">1</span>, <span class="at">weights =</span> <span class="sc">~</span>wt, <span class="at">data =</span> outDatStab)</span>
<span id="cb9-2"><a href="iptw.html#cb9-2" aria-hidden="true" tabindex="-1"></a>fitStab <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(outcome <span class="sc">~</span> nTx, sv1stab)</span>
<span id="cb9-3"><a href="iptw.html#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">coef</span>(fitStab), <span class="fu">confint</span>(fitStab)) [<span class="dv">2</span>,]</span></code></pre></div>
<pre><code>##                   2.5 %      97.5 % 
## -0.13105300 -0.18662568 -0.07548032</code></pre>
</div>
<div id="case-study-of-noise-exposure-and-hypertension" class="section level2" number="7.2">
<h2><span class="header-section-number">7.2</span> case study of noise exposure and hypertension</h2>
<p>소음에 노출된 사람에서 고혈압이 발생하는가?
&gt;load data</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="iptw.html#cb11-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">&#39;data/finaldat_210707.xlsx&#39;</span>)</span>
<span id="cb11-2"><a href="iptw.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 44
##       vo person_id location_id tstart               year exp_noise exp_min
##    &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt; &lt;dttm&gt;              &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;
## 1 227516        18          14 2014-05-15 00:00:00  2014 yes             1
## 2 255450        18        1554 2015-05-13 00:00:00  2015 yes             1
## 3 227492        22          14 2014-05-15 00:00:00  2014 no              0
## 4 255510        22        1554 2015-05-13 00:00:00  2015 no              0
## 5 280838        22        1554 2016-05-11 00:00:00  2016 no              0
## 6 227463        26        1502 2014-05-15 00:00:00  2014 no              0
## # … with 37 more variables: exp_crdvsc &lt;chr&gt;, exp_night &lt;dbl&gt;, exp_nitro &lt;dbl&gt;,
## #   exp_dcm &lt;dbl&gt;, exp_dcfm &lt;dbl&gt;, exp_dcf &lt;dbl&gt;, exp_anitril &lt;dbl&gt;,
## #   exp_cs2 &lt;dbl&gt;, exp_tce &lt;dbl&gt;, exp_anti &lt;dbl&gt;, exp_cnna &lt;dbl&gt;,
## #   exp_kcn &lt;dbl&gt;, exp_hcn &lt;dbl&gt;, exp_no2 &lt;dbl&gt;, exp_co &lt;dbl&gt;, exp_vib &lt;dbl&gt;,
## #   exp_hipr &lt;dbl&gt;, exp_pb &lt;dbl&gt;, exp_cd &lt;dbl&gt;, age &lt;dbl&gt;, htn &lt;chr&gt;,
## #   sex &lt;chr&gt;, smokh &lt;chr&gt;, agegp &lt;chr&gt;, BMI &lt;chr&gt;, exercise &lt;chr&gt;, dm &lt;chr&gt;,
## #   pr_rgr04 &lt;chr&gt;, bd_rgr3 &lt;dbl&gt;, sum &lt;dbl&gt;, waist_obs &lt;chr&gt;, tstop &lt;dttm&gt;,
## #   htn_oc &lt;chr&gt;, tstart2 &lt;dbl&gt;, tstop2 &lt;dbl&gt;, flag &lt;dbl&gt;, htnoc1st &lt;dbl&gt;</code></pre>
<p>long form이므로 wide 형태로 변형.</p>
<p>2014, 2015, 2016</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="iptw.html#cb13-1" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">=</span> dat <span class="co"># %&gt;% slice(1:17)</span></span>
<span id="cb13-2"><a href="iptw.html#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="iptw.html#cb13-3" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">=</span> dat2 <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="iptw.html#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(person_id, year,flag, exp_noise, exp_crdvsc, tstart2, tstop2, age, sex, </span>
<span id="cb13-5"><a href="iptw.html#cb13-5" aria-hidden="true" tabindex="-1"></a>         smokh, BMI, exercise, dm, pr_rgr04, sum, htn_oc)</span>
<span id="cb13-6"><a href="iptw.html#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="iptw.html#cb13-7" aria-hidden="true" tabindex="-1"></a>dat3 <span class="ot">=</span> dat2 <span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a href="iptw.html#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">exp_noise=</span><span class="fu">as.numeric</span>(exp_noise <span class="sc">==</span> <span class="st">&#39;yes&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="iptw.html#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#select(person_id, tstart, year, exp_noise, htnoc1st) %&gt;%</span></span>
<span id="cb13-10"><a href="iptw.html#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">py =</span> tstop2 <span class="sc">-</span> tstart2) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(tstart2, tstop2)) <span class="sc">%&gt;%</span></span>
<span id="cb13-11"><a href="iptw.html#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, as.character, is.factor, as.character) <span class="sc">%&gt;%</span></span>
<span id="cb13-12"><a href="iptw.html#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(person_id, year, flag), </span>
<span id="cb13-13"><a href="iptw.html#cb13-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;variables&quot;</span>, </span>
<span id="cb13-14"><a href="iptw.html#cb13-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span><span class="st">&quot;values&quot;</span>, </span>
<span id="cb13-15"><a href="iptw.html#cb13-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_transform =</span> <span class="fu">list</span>(<span class="at">val =</span> as.character))  <span class="sc">%&gt;%</span></span>
<span id="cb13-16"><a href="iptw.html#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">variables2=</span> <span class="fu">paste0</span>(variables, <span class="st">&quot;_&quot;</span>, flag)) <span class="sc">%&gt;%</span></span>
<span id="cb13-17"><a href="iptw.html#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>variables, <span class="sc">-</span>flag, <span class="sc">-</span>year) <span class="sc">%&gt;%</span></span>
<span id="cb13-18"><a href="iptw.html#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> variables2, </span>
<span id="cb13-19"><a href="iptw.html#cb13-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from=</span> values) <span class="sc">%&gt;%</span></span>
<span id="cb13-20"><a href="iptw.html#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(htn_oc_3)) <span class="sc">%&gt;%</span></span>
<span id="cb13-21"><a href="iptw.html#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="iptw.html#cb14-1" aria-hidden="true" tabindex="-1"></a>iptw.Ex <span class="ot">=</span>  <span class="fu">iptw</span>(<span class="fu">list</span>(</span>
<span id="cb14-2"><a href="iptw.html#cb14-2" aria-hidden="true" tabindex="-1"></a>  exp_noise_1 <span class="sc">~</span> BMI_1 <span class="sc">+</span> sex_1 <span class="sc">+</span> age_1, </span>
<span id="cb14-3"><a href="iptw.html#cb14-3" aria-hidden="true" tabindex="-1"></a>  exp_noise_2 <span class="sc">~</span> BMI_2 <span class="sc">+</span> exp_noise_1 <span class="sc">+</span> sex_1 <span class="sc">+</span> age_1, </span>
<span id="cb14-4"><a href="iptw.html#cb14-4" aria-hidden="true" tabindex="-1"></a>  exp_noise_3 <span class="sc">~</span> BMI_3 <span class="sc">+</span> BMI_2 <span class="sc">+</span> BMI_1 <span class="sc">+</span> exp_noise_2 <span class="sc">+</span> sex_1 <span class="sc">+</span> age_1), </span>
<span id="cb14-5"><a href="iptw.html#cb14-5" aria-hidden="true" tabindex="-1"></a>  timeInvariant <span class="sc">~</span> sex_1 <span class="sc">+</span> age_1, </span>
<span id="cb14-6"><a href="iptw.html#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>dat3, </span>
<span id="cb14-7"><a href="iptw.html#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">cumulative =</span> <span class="cn">FALSE</span>, </span>
<span id="cb14-8"><a href="iptw.html#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">priorTreatment =</span> <span class="cn">FALSE</span>, </span>
<span id="cb14-9"><a href="iptw.html#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>, </span>
<span id="cb14-10"><a href="iptw.html#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">stop.method =</span> <span class="st">&quot;es.max&quot;</span>, </span>
<span id="cb14-11"><a href="iptw.html#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.trees =</span> <span class="dv">1000</span></span>
<span id="cb14-12"><a href="iptw.html#cb14-12" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="mixed-model.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="covid-data-step.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["methods.pdf", "methods.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
