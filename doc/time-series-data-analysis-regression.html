<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Time series data analysis, regression | 직업환경보건 연구방법론</title>
  <meta name="description" content="직업환경보건 연구에서 필요한 연구방법론 정리." />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Time series data analysis, regression | 직업환경보건 연구방법론" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="직업환경보건 연구에서 필요한 연구방법론 정리." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Time series data analysis, regression | 직업환경보건 연구방법론" />
  
  <meta name="twitter:description" content="직업환경보건 연구에서 필요한 연구방법론 정리." />
  

<meta name="author" content="윤진하" />


<meta name="date" content="2021-08-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="직업병-연구방법론.html"/>
<link rel="next" href="nested-case-control-study.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> 소개</a></li>
<li class="chapter" data-level="2" data-path="직업병-연구방법론.html"><a href="직업병-연구방법론.html"><i class="fa fa-check"></i><b>2</b> 직업병 연구방법론</a></li>
<li class="chapter" data-level="3" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html"><i class="fa fa-check"></i><b>3</b> Time series data analysis, regression</a>
<ul>
<li class="chapter" data-level="3.1" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#introduction"><i class="fa fa-check"></i><b>3.1</b> introduction</a></li>
<li class="chapter" data-level="3.2" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#a-case-study-in-air-pollution-and-health"><i class="fa fa-check"></i><b>3.2</b> A case study in Air Pollution and Health</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#starting-up"><i class="fa fa-check"></i><b>3.2.1</b> Starting Up</a></li>
<li class="chapter" data-level="3.2.2" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#statistical-issues-in-estimating-the-health-effects-of-spatialtemporal-environmental-exposures"><i class="fa fa-check"></i><b>3.2.2</b> Statistical Issues in Estimating the Health Effects of Spatial–Temporal Environmental Exposures</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#simulation-study-for-pm10-and-cvd-mortality"><i class="fa fa-check"></i><b>3.3</b> simulation study for pm10 and cvd mortality</a></li>
<li class="chapter" data-level="3.4" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#case-study-influenza-epidemic-and-suicide"><i class="fa fa-check"></i><b>3.4</b> case study: influenza epidemic and suicide</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#실습-데이터"><i class="fa fa-check"></i><b>3.4.1</b> 실습 데이터</a></li>
<li class="chapter" data-level="3.4.2" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#simple-time-related-variable-adjusting-regression"><i class="fa fa-check"></i><b>3.4.2</b> simple time-related variable adjusting regression</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#analysis-and-forecasting-regression"><i class="fa fa-check"></i><b>3.5</b> analysis and forecasting, regression</a></li>
<li class="chapter" data-level="3.6" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#arima"><i class="fa fa-check"></i><b>3.6</b> ARIMA</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#arima-감기-자살-aic"><i class="fa fa-check"></i><b>3.6.1</b> arima 감기 자살 , AIC</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="time-series-data-analysis-regression.html"><a href="time-series-data-analysis-regression.html#aic-bic-in-generalize-additive-model"><i class="fa fa-check"></i><b>3.7</b> AIC BIC in generalize additive model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="nested-case-control-study.html"><a href="nested-case-control-study.html"><i class="fa fa-check"></i><b>4</b> Nested Case Control Study</a>
<ul>
<li class="chapter" data-level="4.1" data-path="nested-case-control-study.html"><a href="nested-case-control-study.html#simple-tutor-for-nested-case-control-ncc-study"><i class="fa fa-check"></i><b>4.1</b> simple tutor for nested case control (NCC) study</a></li>
<li class="chapter" data-level="4.2" data-path="nested-case-control-study.html"><a href="nested-case-control-study.html#sampling-schemes-for-nested-case-control-studies"><i class="fa fa-check"></i><b>4.2</b> Sampling schemes for nested case-control studies</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="survival-data.html"><a href="survival-data.html"><i class="fa fa-check"></i><b>5</b> Survival Data</a>
<ul>
<li class="chapter" data-level="5.1" data-path="survival-data.html"><a href="survival-data.html#cox-proportional"><i class="fa fa-check"></i><b>5.1</b> Cox Proportional</a></li>
<li class="chapter" data-level="5.2" data-path="survival-data.html"><a href="survival-data.html#non-proportional-model"><i class="fa fa-check"></i><b>5.2</b> non-proportional model</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="survival-data.html"><a href="survival-data.html#log-rank-test"><i class="fa fa-check"></i><b>5.2.1</b> log-rank test</a></li>
<li class="chapter" data-level="5.2.2" data-path="survival-data.html"><a href="survival-data.html#python-tutor-윤동규"><i class="fa fa-check"></i><b>5.2.2</b> python tutor 윤동규</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mixed-model.html"><a href="mixed-model.html"><i class="fa fa-check"></i><b>6</b> Mixed Model</a>
<ul>
<li class="chapter" data-level="6.1" data-path="mixed-model.html"><a href="mixed-model.html#introduction-1"><i class="fa fa-check"></i><b>6.1</b> introduction</a></li>
<li class="chapter" data-level="6.2" data-path="mixed-model.html"><a href="mixed-model.html#data-step-1"><i class="fa fa-check"></i><b>6.2</b> data step 1</a></li>
<li class="chapter" data-level="6.3" data-path="mixed-model.html"><a href="mixed-model.html#data-analysis-start"><i class="fa fa-check"></i><b>6.3</b> Data analysis start</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="mixed-model.html"><a href="mixed-model.html#job-loss-due-to-covid19-psychological-aggravation-according-to-gender"><i class="fa fa-check"></i><b>6.3.1</b> job loss due to COVID19, psychological aggravation according to Gender</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="iptw.html"><a href="iptw.html"><i class="fa fa-check"></i><b>7</b> IPTW</a>
<ul>
<li class="chapter" data-level="7.1" data-path="iptw.html"><a href="iptw.html#package-tutorial"><i class="fa fa-check"></i><b>7.1</b> package tutorial</a></li>
<li class="chapter" data-level="7.2" data-path="iptw.html"><a href="iptw.html#case-study-of-noise-exposure-and-hypertension"><i class="fa fa-check"></i><b>7.2</b> case study of noise exposure and hypertension</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="covid-data-step.html"><a href="covid-data-step.html"><i class="fa fa-check"></i><b>8</b> covid data step</a>
<ul>
<li class="chapter" data-level="8.1" data-path="covid-data-step.html"><a href="covid-data-step.html#load-data-of-int-and-kr"><i class="fa fa-check"></i><b>8.1</b> load data of Int and Kr</a></li>
<li class="chapter" data-level="8.2" data-path="covid-data-step.html"><a href="covid-data-step.html#data-merge"><i class="fa fa-check"></i><b>8.2</b> data merge</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html"><i class="fa fa-check"></i><b>9</b> 산업보건분야에서 건강보험공단 자료 분석</a>
<ul>
<li class="chapter" data-level="9.1" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html#빅데이터-위원회"><i class="fa fa-check"></i><b>9.1</b> 빅데이터 위원회</a></li>
<li class="chapter" data-level="9.2" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html#직업환경분야-건강보험공단-자료-분석"><i class="fa fa-check"></i><b>9.2</b> 직업환경분야 건강보험공단 자료 분석</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html#건강보험공단-자료-및-사용"><i class="fa fa-check"></i><b>9.2.1</b> 건강보험공단 자료 및 사용</a></li>
<li class="chapter" data-level="9.2.2" data-path="산업보건분야에서-건강보험공단-자료-분석.html"><a href="산업보건분야에서-건강보험공단-자료-분석.html#건강보험공단-자료-분석-방법"><i class="fa fa-check"></i><b>9.2.2</b> 건강보험공단 자료 분석 방법</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">직업환경보건 연구방법론</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="time-series-data-analysis-regression" class="section level1" number="3">
<h1><span class="header-section-number">Chapter 3</span> Time series data analysis, regression</h1>
<div id="introduction" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> introduction</h2>
<p>시계열적 자료를 분석하고 나타나는 현상과 특정 요인과 관련성을 탐색해보는 시간입니다.
예를 들어 미세먼지가 높은 날 심혈관 질환이 발생하는가?에 대한 질문에 답하기 위해서 생가할 것이 몇가지 있습니다.
미세먼지가 높은 날이란? 심혈관 질환 사망이 높은 날이란? 이 두가지 요소를 검토하게 됩니다. <br>
그런데 심혈관 질환의 사망은 요일마다 다르고, 계절에 따라 변동하며, 장기 적으로는 점차 증가 또는 감소를 합니다. 그런데 미세먼지도 점차 증가하고 있으니, 단순 상관관계를 보면 미세먼지도 증가 심혈관 사망도 증가하면 양의 관련성을 보이게 됩니다.
마찬가지로 GDP와 자살의 관계를 보면 어떨까요? 우리나라의 자살률은 증가하고 있습니다. 그런데 GDP도 증가하고 있습니다. 그러니 GDP의 증가와 자살의 증가는 양의 상관관계가 있다고 나옵니다. 맞나요?
네 심혈관 사망, 자살의 증가의 계절적 요소, 장기간 추세(trend)가 아니라 변동이 미세먼지나 GDP의 변동과 어떠한 관계가 있는지가 우리의 궁금증일 것 입니다. 이러한 궁금증을 R을 이용해서 풀어보도록 하겠습니다.
몇몇은 영어 책을 요약한 것인데, 아직 한글로 옮기지 못해 영어와 한글이 혼용되어 있으니 양해 바랍니다.</p>
<p>동영상은 아래와 같습니다.</p>
<p><iframe width="560" height="315" src="https://www.youtube.com/embed/zomJ3ZD96tU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></p>
</div>
<div id="a-case-study-in-air-pollution-and-health" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> A case study in Air Pollution and Health</h2>
<p>the original book is <a href="https://www.springer.com/gp/book/9780387781662" class="uri">https://www.springer.com/gp/book/9780387781662</a>
이 책에서 중요한 부분을 요약하고, 몇몇을 추가하여 진행하겠습니다. 원본을 읽어 보시는 것을 추천해 드립니다.</p>
<div id="starting-up" class="section level3" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Starting Up</h3>
<p>This book used <code>NMMAPSlite</code> packages, but that packages and data are not easy to use. So, Gasparrini’s packages <code>dlnm</code> and its’ data used in this summary tutor (<a href="https://github.com/gasparrini/dlnm/tree/master/data" class="uri">https://github.com/gasparrini/dlnm/tree/master/data</a>)</p>
<p>Load library</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="time-series-data-analysis-regression.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb1-2"><a href="time-series-data-analysis-regression.html#cb1-2" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;tidyverse&quot;</span>, <span class="st">&quot;dlnm&quot;</span>, <span class="st">&quot;tidyverse&quot;</span>,<span class="st">&quot;ggplot2&quot;</span>,<span class="st">&quot;plotly&quot;</span>,<span class="st">&quot;readxl&quot;</span>,<span class="st">&quot;lubridate&quot;</span>,</span>
<span id="cb1-3"><a href="time-series-data-analysis-regression.html#cb1-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;DBI&quot;</span>, <span class="st">&quot;forecast&quot;</span>, <span class="st">&quot;gsheet&quot;</span>, <span class="st">&quot;Hmisc&quot;</span>, <span class="st">&quot;mgcv&quot;</span>)</span>
<span id="cb1-4"><a href="time-series-data-analysis-regression.html#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (pkg <span class="cf">in</span> pkgs) {</span>
<span id="cb1-5"><a href="time-series-data-analysis-regression.html#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (pkg <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()) <span class="sc">==</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-6"><a href="time-series-data-analysis-regression.html#cb1-6" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">eval</span>( <span class="fu">bquote</span>(<span class="fu">install.packages</span>(.(pkg))) )}</span>
<span id="cb1-7"><a href="time-series-data-analysis-regression.html#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> </span>
<span id="cb1-8"><a href="time-series-data-analysis-regression.html#cb1-8" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">eval</span>(<span class="fu">bquote</span>(<span class="fu">library</span>(.(pkg))))}  </span>
<span id="cb1-9"><a href="time-series-data-analysis-regression.html#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="statistical-issues-in-estimating-the-health-effects-of-spatialtemporal-environmental-exposures" class="section level3" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Statistical Issues in Estimating the Health Effects of Spatial–Temporal Environmental Exposures</h3>
<div id="tell-a-story" class="section level4" number="3.2.2.1">
<h4><span class="header-section-number">3.2.2.1</span> tell a story</h4>
<p>I want to tell a story ‘relationship between day-to-day changes air pollution levels and day-to-day changes in mortality counts’. So, we need useful statistical models for <strong>estimating associations rather than for prediction</strong>.</p>
</div>
<div id="estimation-vs.-predictiion" class="section level4" number="3.2.2.2">
<h4><span class="header-section-number">3.2.2.2</span> Estimation Vs. Predictiion</h4>
<p>One question of scientific interest might be, “Are changes in the PM10 series associated with changes in the mortality series?” This question is fundamentally about the relationship between a time-varying health outcome <span class="math inline">\(y_{t}\)</span> and a time-varying exposure <span class="math inline">\(x_{t}\)</span>. A simple linear model might relate</p>
<p><span class="math display">\[Y_{i}=\beta_{0}+\beta_{1}\textrm{x}_{t}+\epsilon_{t} \tag{1.1}\]</span></p>
<table>
<colgroup>
<col width="27%" />
<col width="72%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">estimates</th>
<th align="left">contents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(\beta_{0}\)</span></td>
<td align="left">the mean mortality count</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(\beta_{1}\)</span></td>
<td align="left">tthe increase in mortality associated with a unit increase in PM10(<span class="math inline">\(x_{t}\)</span>)</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(\epsilon_{t}\)</span></td>
<td align="left">a stationary mean zero error process.</td>
</tr>
</tbody>
</table>
<p>For example, suppose we took the exposure series <span class="math inline">\(x_{t}\)</span> and
decomposed it into two parts, <strong>average(<span class="math inline">\(\bar{x}_{t}^{Y}\)</span>) + deviation(<span class="math inline">\(x_{t} - \bar{x}_{t}^{Y}\)</span>)</strong></p>
<p><strong>average:</strong> <span class="math inline">\(\bar{x}_{t}^{Y}\)</span>
<strong>deviation:</strong> <span class="math inline">\(x_{t} - \bar{x}_{t}^{Y}\)</span></p>
<p>So, we can reformulate (1.1) as below</p>
<p><span class="math display">\[Y_{t}=\beta_{0}+
\beta_{1}\bar{x}_{t}^{Y}+\beta_{2}(x_{t} - \bar{x}_{t}^{Y})
+\epsilon_{t} \tag{1.2}\]</span></p>
<p>Note that model (1.2) is equivalent to model (1.1) if β1 = β2, however,
model (1.2) does not require them to be equal.</p>
<p>In the same context, the yearly average can be decomposing seasonal average or monthly average (<span class="math inline">\(z_{t}\)</span>)
<span class="math display">\[z_{t} = \bar{z}_{t}^{S}+(z_{t} - \bar{z}_{t}^{S}) \tag{1.3}\]</span>
So, we can use following model</p>
<p><span class="math display">\[Y_{t}=\beta_{0}+
\beta_{1}\bar{x}_{t}^{Y}+\beta_{2}\bar{z}_{t}^{S}+\beta_{3}(z_{t} - \bar{z}_{t}^{S})
+\epsilon_{t} \tag{1.2}\]</span></p>
<p>Going to step further, we can add or decompose weekly moving average (<span class="math inline">\(u_{t}\)</span>)
<span class="math display">\[u_{t} = \bar{u}_{t}^{W}+(u_{t} - \bar{u}_{t}^{W}) \tag{1.4}\]</span></p>
<p>Let, residual variation (<span class="math inline">\(r_{t}\)</span>) as <span class="math inline">\(r_{t} = (u_{t} - \bar{u}_{t}^{W})\)</span>. then our expanded model is now</p>
<p><span class="math display">\[Y_{t}=\beta_{0}+
\beta_{1}\bar{x}_{t}^{Y}+\beta_{2}\bar{z}_{t}^{S}+\beta_{3}\bar{u}_{t}^W +\beta_{4}r_{t}
+\epsilon_{t} \tag{1.5}\]</span></p>
<p>The parameter β4 describes the association between yt and the sub-weekly
fluctuations in <span class="math inline">\(x_{t}\)</span> (adjusted for the yearly, seasonal, and weekly variation).</p>
<blockquote>
<p>Question &amp; Discussion: What’s mean of <span class="math inline">\(\beta_{4}\)</span></p>
</blockquote>
</div>
</div>
</div>
<div id="simulation-study-for-pm10-and-cvd-mortality" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> simulation study for pm10 and cvd mortality</h2>
<p>First, let’s use simulation data to help us understand some time series data analysis.</p>
<blockquote>
<p>Let’s think of x as a day, and hypothetically create a random variable y1 and pm10 (fine dust) multiplied by 4.5 for 300 days</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="time-series-data-analysis-regression.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb2-2"><a href="time-series-data-analysis-regression.html#cb2-2" aria-hidden="true" tabindex="-1"></a>x  <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">300</span></span>
<span id="cb2-3"><a href="time-series-data-analysis-regression.html#cb2-3" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> <span class="dv">5</span><span class="sc">*</span><span class="fu">rnorm</span>(<span class="dv">300</span>, <span class="at">sd=</span>.<span class="dv">1</span>)<span class="sc">+</span><span class="dv">15</span></span>
<span id="cb2-4"><a href="time-series-data-analysis-regression.html#cb2-4" aria-hidden="true" tabindex="-1"></a>pm <span class="ot">&lt;-</span> y1<span class="sc">*</span><span class="fl">4.5</span></span>
<span id="cb2-5"><a href="time-series-data-analysis-regression.html#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, pm, <span class="at">type=</span><span class="st">&#39;l&#39;</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/random%20variable-1.png" width="672" /></p>
<blockquote>
<p>Here, it is assumed that the long term trend gradually increases, and seasonal factor through the <code>sin()</code> function were added, and multiplying it by 0.03.</p>
</blockquote>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="time-series-data-analysis-regression.html#cb3-1" aria-hidden="true" tabindex="-1"></a>y2 <span class="ot">&lt;-</span> y1<span class="sc">*</span><span class="dv">5</span><span class="sc">+</span> <span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span><span class="dv">5</span><span class="sc">+</span> x <span class="sc">*</span> <span class="fl">0.03</span> </span>
<span id="cb3-2"><a href="time-series-data-analysis-regression.html#cb3-2" aria-hidden="true" tabindex="-1"></a>y2[y2<span class="sc">&lt;</span> <span class="dv">0</span>]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb3-3"><a href="time-series-data-analysis-regression.html#cb3-3" aria-hidden="true" tabindex="-1"></a>y3<span class="ot">&lt;-</span><span class="fu">round</span>(y2)</span>
<span id="cb3-4"><a href="time-series-data-analysis-regression.html#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(y3, <span class="at">type=</span><span class="st">&#39;l&#39;</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/seasonal%20randome-1.png" width="672" /></p>
<blockquote>
<p>I tried adding delay effects and days with specific events. And I created a dataframe.</p>
</blockquote>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="time-series-data-analysis-regression.html#cb4-1" aria-hidden="true" tabindex="-1"></a>lag <span class="ot">&lt;-</span><span class="dv">6</span></span>
<span id="cb4-2"><a href="time-series-data-analysis-regression.html#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y3)</span></code></pre></div>
<pre><code>## [1] 79.58667</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="time-series-data-analysis-regression.html#cb6-1" aria-hidden="true" tabindex="-1"></a>death <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">80</span>,<span class="dv">79</span>,<span class="dv">81</span>), (lag<span class="sc">/</span><span class="dv">3</span>)), y3[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(y3)<span class="sc">-</span>lag)])  </span>
<span id="cb6-2"><a href="time-series-data-analysis-regression.html#cb6-2" aria-hidden="true" tabindex="-1"></a>event <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">240</span>)) </span>
<span id="cb6-3"><a href="time-series-data-analysis-regression.html#cb6-3" aria-hidden="true" tabindex="-1"></a>eventd <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">40</span>,<span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">30</span>, <span class="dv">30</span>), <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">240</span>))</span>
<span id="cb6-4"><a href="time-series-data-analysis-regression.html#cb6-4" aria-hidden="true" tabindex="-1"></a>death2<span class="ot">&lt;-</span>death<span class="sc">+</span>eventd<span class="sc">+</span><span class="dv">10</span></span>
<span id="cb6-5"><a href="time-series-data-analysis-regression.html#cb6-5" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(x, pm, y3, death, event, death2) </span>
<span id="cb6-6"><a href="time-series-data-analysis-regression.html#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gg)</span></code></pre></div>
<pre><code>##   x       pm y3 death event death2
## 1 1 66.09048 76    80     1    130
## 2 2 67.91320 80    79     1    129
## 3 3 65.61984 78    81     1    131
## 4 4 71.08938 84    80     1    130
## 5 5 68.24139 79    79     1    129
## 6 6 65.65395 74    81     1    131</code></pre>
<blockquote>
<p>Now let’s make plot. There is an event in the first 50 days, so cardiovascular mortality is high. Then cvd is increasing slowly with a seasonal component. Fine dust was created with random + seasonal elements.</p>
</blockquote>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="time-series-data-analysis-regression.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, pm, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">140</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">300</span>))</span>
<span id="cb8-2"><a href="time-series-data-analysis-regression.html#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb8-3"><a href="time-series-data-analysis-regression.html#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, death2, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.7</span>), <span class="at">type=</span><span class="st">&quot;p&quot;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<blockquote>
<p>Now let’s do a simple regression analysis. What relationship are you observing? A lot of people die during the event. But there were no relationship between PM10 and CVD mortality. Oh~NO! It is clearly created CVD mortality data by simulation to relate with fine dust. Yes. ‘lag’ and ‘seasonality’ are not considered yet.</p>
</blockquote>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="time-series-data-analysis-regression.html#cb9-1" aria-hidden="true" tabindex="-1"></a>mt3 <span class="ot">&lt;-</span> <span class="fu">glm</span>(death2 <span class="sc">~</span> x<span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span>pm<span class="sc">+</span>event)</span>
<span id="cb9-2"><a href="time-series-data-analysis-regression.html#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mt3)<span class="sc">$</span>coefficients</span></code></pre></div>
<pre><code>##                Estimate  Std. Error     t value      Pr(&gt;|t|)
## (Intercept) 90.10455149 6.861474711  13.1319513  2.476263e-31
## x            0.02379324 0.003500538   6.7970236  5.915161e-11
## sin(x/2)    -4.41585403 0.308633540 -14.3077581  1.247252e-35
## pm          -0.06144597 0.101078610  -0.6079028  5.437196e-01
## event       35.05109683 0.757861036  46.2500315 3.230388e-137</code></pre>
<blockquote>
<p>let’s review the plot, how about the fitted line?</p>
</blockquote>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="time-series-data-analysis-regression.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, pm, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">140</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">300</span>))</span>
<span id="cb11-2"><a href="time-series-data-analysis-regression.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb11-3"><a href="time-series-data-analysis-regression.html#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, death2, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.7</span>), <span class="at">type=</span><span class="st">&quot;p&quot;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb11-4"><a href="time-series-data-analysis-regression.html#cb11-4" aria-hidden="true" tabindex="-1"></a>mp3 <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="fu">predict</span>(mt3))</span>
<span id="cb11-5"><a href="time-series-data-analysis-regression.html#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, mp3, <span class="at">col=</span><span class="dv">75</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/plot%20regression%20line%20simple-1.png" width="672" /></p>
<blockquote>
<p>now, here is simple regression model between residual of death and pm10. Is it correct?</p>
</blockquote>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="time-series-data-analysis-regression.html#cb12-1" aria-hidden="true" tabindex="-1"></a>mt2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(death2 <span class="sc">~</span> x<span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span>event)</span>
<span id="cb12-2"><a href="time-series-data-analysis-regression.html#cb12-2" aria-hidden="true" tabindex="-1"></a>resid_mt2 <span class="ot">&lt;-</span><span class="fu">resid</span>(mt2)</span>
<span id="cb12-3"><a href="time-series-data-analysis-regression.html#cb12-3" aria-hidden="true" tabindex="-1"></a>risk.m0<span class="ot">&lt;-</span><span class="fu">glm</span>(resid_mt2 <span class="sc">~</span> pm, <span class="at">family=</span>gaussian)</span>
<span id="cb12-4"><a href="time-series-data-analysis-regression.html#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(risk.m0)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = resid_mt2 ~ pm, family = gaussian)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -9.6006  -2.2804  -0.1559   2.3275  14.2142  
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)  4.14114    6.79037    0.61    0.542
## pm          -0.06128    0.10043   -0.61    0.542
## 
## (Dispersion parameter for gaussian family taken to be 14.18007)
## 
##     Null deviance: 4230.9  on 299  degrees of freedom
## Residual deviance: 4225.7  on 298  degrees of freedom
## AIC: 1650.9
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="time-series-data-analysis-regression.html#cb14-1" aria-hidden="true" tabindex="-1"></a>risk.mp0 <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="fu">predict</span>(risk.m0))</span>
<span id="cb14-2"><a href="time-series-data-analysis-regression.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pm, resid_mt2, <span class="at">type=</span><span class="st">&#39;p&#39;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb14-3"><a href="time-series-data-analysis-regression.html#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(pm, (risk.mp0), <span class="at">col=</span><span class="dv">25</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/residual%20plot%201-1.png" width="672" /></p>
<blockquote>
<p>Here is another simple regression model between residual of death and residual of pm10. Is it correct?</p>
</blockquote>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="time-series-data-analysis-regression.html#cb15-1" aria-hidden="true" tabindex="-1"></a>mt2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(death2 <span class="sc">~</span> x<span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span>event)</span>
<span id="cb15-2"><a href="time-series-data-analysis-regression.html#cb15-2" aria-hidden="true" tabindex="-1"></a>resid_mt2 <span class="ot">&lt;-</span><span class="fu">resid</span>(mt2)</span>
<span id="cb15-3"><a href="time-series-data-analysis-regression.html#cb15-3" aria-hidden="true" tabindex="-1"></a>pm2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(pm <span class="sc">~</span> x<span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb15-4"><a href="time-series-data-analysis-regression.html#cb15-4" aria-hidden="true" tabindex="-1"></a>resid_pm2 <span class="ot">&lt;-</span><span class="fu">resid</span>(pm2)</span>
<span id="cb15-5"><a href="time-series-data-analysis-regression.html#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="time-series-data-analysis-regression.html#cb15-6" aria-hidden="true" tabindex="-1"></a>risk.m1<span class="ot">&lt;-</span><span class="fu">glm</span>(resid_mt2 <span class="sc">~</span> resid_pm2, <span class="at">family=</span>gaussian)</span>
<span id="cb15-7"><a href="time-series-data-analysis-regression.html#cb15-7" aria-hidden="true" tabindex="-1"></a>risk.mp1 <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="fu">predict</span>(risk.m1))</span>
<span id="cb15-8"><a href="time-series-data-analysis-regression.html#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(resid_pm2, resid_mt2, <span class="at">type=</span><span class="st">&#39;p&#39;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb15-9"><a href="time-series-data-analysis-regression.html#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(resid_pm2, (risk.mp0), <span class="at">col=</span><span class="dv">25</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/residual%20plot%202-1.png" width="672" />
This is an intuitive graph. The relationship between two residuals after removing time trends, seasonal fluctation.</p>
<div id="autocorrelation" class="section level4" number="3.3.0.1">
<h4><span class="header-section-number">3.3.0.1</span> Autocorrelation</h4>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="time-series-data-analysis-regression.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb16-2"><a href="time-series-data-analysis-regression.html#cb16-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> <span class="fu">cbind</span>(<span class="st">&#39;time&#39;</span><span class="ot">=</span>x, pm,death2,event) <span class="sc">%&gt;%</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">tibble</span>()</span>
<span id="cb16-3"><a href="time-series-data-analysis-regression.html#cb16-3" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##    time    pm death2 event
##   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
## 1     1  66.1    130     1
## 2     2  67.9    129     1
## 3     3  65.6    131     1
## 4     4  71.1    130     1
## 5     5  68.2    129     1
## 6     6  65.7    131     1</code></pre>
<p>Autocorrelation is the amount of association observations at a time and other observations with time lag. For example, weekend have 7 days autocorrelation, and seasons have 12 months autocorrelation.</p>
<p><span class="math display">\[ r(k) = \frac{1}{N} \sum_{t=1}^{N-k} 
 (x_{t} - \bar{x})(x_{t+k} - \bar{x})/c(0) \tag{2.1}  \]</span></p>
<p><span class="math display">\[ c(0) = \frac{1}{N} \sum_{t=1}^{N-k}(x_{t} - \bar{x})^2 \]</span></p>
<p>One of the most important factor in autocorrelation is the seasonal factor, so compare ACF plot before and after removing the seasonal factor</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="time-series-data-analysis-regression.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#par(mflow)</span></span>
<span id="cb18-2"><a href="time-series-data-analysis-regression.html#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">2</span>))</span>
<span id="cb18-3"><a href="time-series-data-analysis-regression.html#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, death2, <span class="at">type=</span><span class="st">&#39;p&#39;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb18-4"><a href="time-series-data-analysis-regression.html#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(dat<span class="sc">$</span>death2)</span>
<span id="cb18-5"><a href="time-series-data-analysis-regression.html#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># adjusting seasonality</span></span>
<span id="cb18-6"><a href="time-series-data-analysis-regression.html#cb18-6" aria-hidden="true" tabindex="-1"></a>ar1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(death2 <span class="sc">~</span> x <span class="sc">+</span><span class="fu">sin</span>(x<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span>event)</span>
<span id="cb18-7"><a href="time-series-data-analysis-regression.html#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, death2, <span class="at">type=</span><span class="st">&#39;p&#39;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb18-8"><a href="time-series-data-analysis-regression.html#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">predict</span>(ar1), <span class="at">col =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb18-9"><a href="time-series-data-analysis-regression.html#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(ar1))</span>
<span id="cb18-10"><a href="time-series-data-analysis-regression.html#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># adjusting seasonality by gam model</span></span>
<span id="cb18-11"><a href="time-series-data-analysis-regression.html#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb18-12"><a href="time-series-data-analysis-regression.html#cb18-12" aria-hidden="true" tabindex="-1"></a>ar2 <span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(x,<span class="at">bs=</span><span class="st">&quot;cc&quot;</span>, <span class="at">k=</span><span class="dv">100</span>)<span class="sc">+</span>event, <span class="at">family=</span>gaussian)</span>
<span id="cb18-13"><a href="time-series-data-analysis-regression.html#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, death2, <span class="at">type=</span><span class="st">&#39;p&#39;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb18-14"><a href="time-series-data-analysis-regression.html#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, <span class="fu">predict</span>(ar2), <span class="at">col =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb18-15"><a href="time-series-data-analysis-regression.html#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(ar2))</span>
<span id="cb18-16"><a href="time-series-data-analysis-regression.html#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb18-17"><a href="time-series-data-analysis-regression.html#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(dat<span class="sc">$</span>death2)</span></code></pre></div>
<pre><code>## Series: dat$death2 
## ARIMA(2,1,2) 
## 
## Coefficients:
##          ar1      ar2      ma1     ma2
##       0.6952  -0.4906  -0.8632  0.7667
## s.e.  0.1099   0.1185   0.0810  0.0872
## 
## sigma^2 estimated as 15.81:  log likelihood=-835.21
## AIC=1680.42   AICc=1680.62   BIC=1698.92</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="time-series-data-analysis-regression.html#cb20-1" aria-hidden="true" tabindex="-1"></a>m1<span class="ot">&lt;-</span><span class="fu">arima</span>(dat<span class="sc">$</span>death2, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb20-2"><a href="time-series-data-analysis-regression.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, death2, <span class="at">type=</span><span class="st">&#39;p&#39;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb20-3"><a href="time-series-data-analysis-regression.html#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(m1), <span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb20-4"><a href="time-series-data-analysis-regression.html#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(m1))</span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-5-1.png" width="960" /></p>
<p>How do we remove or control autocorrelation? What model is more appropriate? if we want to tell the story that mortality rates can be changed with fluctuation of none-seasonal factors, rather than seasonal factors do, we should control or remove autocorrelation.</p>
<p>It would be nice and easy when we use ‘gam’ model. And let’s recall that we’re going to look at the relationship between <code>residual(death)</code> and <code>residual(pm)</code>. There is gam model of cubic spline with 100 df. the summary results of two model is almost same, so we can use gam model of mod1 to find relasionship between two residuals.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="time-series-data-analysis-regression.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb21-2"><a href="time-series-data-analysis-regression.html#cb21-2" aria-hidden="true" tabindex="-1"></a>time   <span class="ot">=</span> dat<span class="sc">$</span>time</span>
<span id="cb21-3"><a href="time-series-data-analysis-regression.html#cb21-3" aria-hidden="true" tabindex="-1"></a>mod1   <span class="ot">=</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> pm <span class="sc">+</span> <span class="fu">s</span>(time, <span class="at">bs=</span><span class="st">&#39;cc&#39;</span>, <span class="at">k=</span><span class="dv">100</span>))</span>
<span id="cb21-4"><a href="time-series-data-analysis-regression.html#cb21-4" aria-hidden="true" tabindex="-1"></a>mod1 <span class="sc">%&gt;%</span> </span>
<span id="cb21-5"><a href="time-series-data-analysis-regression.html#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>## 
## Family: gaussian 
## Link function: identity 
## 
## Formula:
## death2 ~ pm + s(time, bs = &quot;cc&quot;, k = 100)
## 
## Parametric coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 105.38002    6.56030  16.063   &lt;2e-16 ***
## pm           -0.13082    0.09704  -1.348    0.179    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Approximate significance of smooth terms:
##           edf Ref.df     F p-value    
## s(time) 72.67     98 50.72  &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## R-sq.(adj) =  0.943   Deviance explained = 95.7%
## GCV = 13.955  Scale est. = 10.482    n = 300</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="time-series-data-analysis-regression.html#cb23-1" aria-hidden="true" tabindex="-1"></a>rpm    <span class="ot">=</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(pm <span class="sc">~</span> <span class="fu">s</span>(time, <span class="at">bs=</span><span class="st">&#39;cc&#39;</span>, <span class="at">k=</span><span class="dv">100</span>))</span>
<span id="cb23-2"><a href="time-series-data-analysis-regression.html#cb23-2" aria-hidden="true" tabindex="-1"></a>rdeath <span class="ot">=</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(time, <span class="at">bs=</span><span class="st">&#39;cc&#39;</span>, <span class="at">k=</span><span class="dv">100</span>))</span>
<span id="cb23-3"><a href="time-series-data-analysis-regression.html#cb23-3" aria-hidden="true" tabindex="-1"></a>mod2   <span class="ot">=</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(<span class="fu">resid</span>(rdeath) <span class="sc">~</span> <span class="fu">resid</span>(rpm))</span>
<span id="cb23-4"><a href="time-series-data-analysis-regression.html#cb23-4" aria-hidden="true" tabindex="-1"></a>mod2 <span class="sc">%&gt;%</span> </span>
<span id="cb23-5"><a href="time-series-data-analysis-regression.html#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>## 
## Family: gaussian 
## Link function: identity 
## 
## Formula:
## resid(rdeath) ~ resid(rpm)
## 
## Parametric coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)  6.769e-15  1.626e-01   0.000    1.000
## resid(rpm)  -1.036e-01  7.513e-02  -1.379    0.169
## 
## 
## R-sq.(adj) =  0.00301   Deviance explained = 0.634%
## GCV = 7.9884  Scale est. = 7.9352    n = 300</code></pre>
<blockquote>
<p>Lag time effect is another important issue. The assumption of lag is that cvd mortality incresed after 6 day later from PM10 increment time.</p>
</blockquote>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="time-series-data-analysis-regression.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(pm)</span></code></pre></div>
<pre><code>## [1] 67.57556</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="time-series-data-analysis-regression.html#cb27-1" aria-hidden="true" tabindex="-1"></a>lag.pm<span class="ot">&lt;-</span><span class="dv">6</span></span>
<span id="cb27-2"><a href="time-series-data-analysis-regression.html#cb27-2" aria-hidden="true" tabindex="-1"></a>pm.lag <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fl">67.5</span>, lag.pm), pm[<span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(pm)<span class="sc">-</span>lag.pm)])</span>
<span id="cb27-3"><a href="time-series-data-analysis-regression.html#cb27-3" aria-hidden="true" tabindex="-1"></a>resid_mt3 <span class="ot">&lt;-</span><span class="fu">resid</span>(mt3)</span>
<span id="cb27-4"><a href="time-series-data-analysis-regression.html#cb27-4" aria-hidden="true" tabindex="-1"></a>risk.m1<span class="ot">&lt;-</span><span class="fu">glm</span>(resid_mt3 <span class="sc">~</span> pm.lag, <span class="at">family=</span>gaussian)</span>
<span id="cb27-5"><a href="time-series-data-analysis-regression.html#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(risk.m1)<span class="sc">$</span>coefficients</span></code></pre></div>
<pre><code>##               Estimate Std. Error   t value     Pr(&gt;|t|)
## (Intercept) -76.437599 5.21757250 -14.65003 5.620794e-37
## pm.lag        1.131554 0.07720006  14.65743 5.276143e-37</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="time-series-data-analysis-regression.html#cb29-1" aria-hidden="true" tabindex="-1"></a>risk.mp1 <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="fu">predict</span>(risk.m1))</span>
<span id="cb29-2"><a href="time-series-data-analysis-regression.html#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pm.lag, resid_mt3, <span class="at">type=</span><span class="st">&#39;p&#39;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb29-3"><a href="time-series-data-analysis-regression.html#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(pm.lag, risk.mp1, <span class="at">col=</span><span class="dv">25</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/lag%20time%20and%20plot%20and%20regression-1.png" width="672" /></p>
<p>Oh! There is positive association between pm10 and cvd mortality.</p>
<blockquote>
<p>Plot highlight lag effect between cvd and pm10.</p>
</blockquote>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="time-series-data-analysis-regression.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, resid_mt3, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">15</span>, <span class="dv">40</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">300</span>))</span>
<span id="cb30-2"><a href="time-series-data-analysis-regression.html#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb30-3"><a href="time-series-data-analysis-regression.html#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, (pm<span class="dv">-50</span>), <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.7</span>), <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb30-4"><a href="time-series-data-analysis-regression.html#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, (pm.lag<span class="dv">-60</span>), <span class="at">col=</span><span class="st">&#39;red&#39;</span>, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/fit%20plot%201-1.png" width="672" /></p>
<blockquote>
<p>The relationship between pm and cardiovascular death was analyzed after considering the seasonal factor with <code>sin()</code> and the delay effect with <code>lag</code> and removing time series factor(residual)</p>
</blockquote>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="time-series-data-analysis-regression.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages(&#39;mgcv&#39;)</span></span>
<span id="cb31-2"><a href="time-series-data-analysis-regression.html#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb31-3"><a href="time-series-data-analysis-regression.html#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">#library(gam)</span></span>
<span id="cb31-4"><a href="time-series-data-analysis-regression.html#cb31-4" aria-hidden="true" tabindex="-1"></a>mgam<span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs=</span><span class="st">&quot;cc&quot;</span>, <span class="at">k=</span><span class="dv">100</span>)<span class="sc">+</span>event, <span class="at">family=</span>gaussian)</span>
<span id="cb31-5"><a href="time-series-data-analysis-regression.html#cb31-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mgam)</span>
<span id="cb31-6"><a href="time-series-data-analysis-regression.html#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, pm, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.5</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">150</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">300</span>), <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb31-7"><a href="time-series-data-analysis-regression.html#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb31-8"><a href="time-series-data-analysis-regression.html#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, death2, <span class="at">col=</span><span class="fu">grey</span>(<span class="fl">0.7</span>), <span class="at">type=</span><span class="st">&quot;p&quot;</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb31-9"><a href="time-series-data-analysis-regression.html#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">250</span>, <span class="at">y=</span><span class="dv">70</span>, <span class="st">&#39;PM10&#39;</span>)</span>
<span id="cb31-10"><a href="time-series-data-analysis-regression.html#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">150</span>, <span class="at">y=</span><span class="dv">65</span>, <span class="st">&#39;pm10. lag&#39;</span>)</span>
<span id="cb31-11"><a href="time-series-data-analysis-regression.html#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">210</span>, <span class="at">y=</span><span class="dv">110</span>, <span class="st">&#39;Obs_death&#39;</span>)</span>
<span id="cb31-12"><a href="time-series-data-analysis-regression.html#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="dv">10</span>, <span class="at">y=</span><span class="dv">50</span>, <span class="st">&#39;Residual(Obs_Death - Gam(fitting)&#39;</span>)</span>
<span id="cb31-13"><a href="time-series-data-analysis-regression.html#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, p)</span>
<span id="cb31-14"><a href="time-series-data-analysis-regression.html#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, (<span class="fu">resid</span>(mgam)<span class="sc">+</span><span class="dv">50</span>), <span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb31-15"><a href="time-series-data-analysis-regression.html#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(x, pm.lag<span class="dv">-10</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/ts%20summary%20plot%201-1.png" width="672" />
&gt; Let’s solve this by regression analysis. What about the model as k is higher? Yes, you should consider how to choose the lag time and k values. Data driven method is common method to choose fitted model. The minimal AIC or BIC value suggest more fitted model.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="time-series-data-analysis-regression.html#cb32-1" aria-hidden="true" tabindex="-1"></a>mgam<span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs=</span><span class="st">&quot;cc&quot;</span>, <span class="at">k=</span><span class="dv">100</span>)<span class="sc">+</span>event, <span class="at">family=</span>gaussian)</span>
<span id="cb32-2"><a href="time-series-data-analysis-regression.html#cb32-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(mgam)</span>
<span id="cb32-3"><a href="time-series-data-analysis-regression.html#cb32-3" aria-hidden="true" tabindex="-1"></a>risk.pp1 <span class="ot">&lt;-</span><span class="fu">glm</span>(death2 <span class="sc">~</span> p<span class="sc">+</span>pm.lag,<span class="at">family=</span>gaussian)</span>
<span id="cb32-4"><a href="time-series-data-analysis-regression.html#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(risk.pp1)<span class="sc">$</span>coefficients</span></code></pre></div>
<pre><code>##                Estimate  Std. Error   t value     Pr(&gt;|t|)
## (Intercept) -58.3872771 1.937186312 -30.14025 2.402418e-92
## p             1.0000436 0.004566766 218.98286 0.000000e+00
## pm.lag        0.8642815 0.028266084  30.57663 9.482839e-94</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="time-series-data-analysis-regression.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(risk.pp1)</span></code></pre></div>
<pre><code>## [1] 885.3135</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="time-series-data-analysis-regression.html#cb36-1" aria-hidden="true" tabindex="-1"></a>mgam150<span class="ot">&lt;-</span> mgcv<span class="sc">::</span><span class="fu">gam</span>(death2 <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs=</span><span class="st">&quot;cc&quot;</span>, <span class="at">k=</span><span class="dv">10</span>)<span class="sc">+</span>event)</span>
<span id="cb36-2"><a href="time-series-data-analysis-regression.html#cb36-2" aria-hidden="true" tabindex="-1"></a>p150 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mgam150)</span>
<span id="cb36-3"><a href="time-series-data-analysis-regression.html#cb36-3" aria-hidden="true" tabindex="-1"></a>risk.pp150 <span class="ot">&lt;-</span><span class="fu">glm</span>(death2 <span class="sc">~</span> p150<span class="sc">+</span> pm.lag, <span class="at">family=</span>gaussian)</span>
<span id="cb36-4"><a href="time-series-data-analysis-regression.html#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(risk.pp150)<span class="sc">$</span>coefficients</span></code></pre></div>
<pre><code>##                Estimate Std. Error   t value      Pr(&gt;|t|)
## (Intercept) -72.5953393 6.74682944 -10.75992  5.109224e-23
## p150          0.9979243 0.01630871  61.18966 2.087420e-170
## pm.lag        1.0776412 0.09754736  11.04736  5.349868e-24</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="time-series-data-analysis-regression.html#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(risk.pp1, risk.pp150)</span></code></pre></div>
<pre><code>##            df       AIC
## risk.pp1    4  885.3135
## risk.pp150  4 1629.2747</code></pre>
<blockquote>
<p>Let’s find the lag using dlnm packages (distributed lag non-linear model)</p>
</blockquote>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="time-series-data-analysis-regression.html#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dlnm)</span>
<span id="cb40-2"><a href="time-series-data-analysis-regression.html#cb40-2" aria-hidden="true" tabindex="-1"></a>cb1.pm <span class="ot">&lt;-</span><span class="fu">crossbasis</span>(pm, <span class="at">lag=</span><span class="dv">10</span>, <span class="at">argvar=</span><span class="fu">list</span>(<span class="at">fun=</span><span class="st">&quot;lin&quot;</span>),</span>
<span id="cb40-3"><a href="time-series-data-analysis-regression.html#cb40-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">arglag=</span><span class="fu">list</span>(<span class="at">fun=</span><span class="st">&quot;poly&quot;</span>, <span class="at">degree=</span><span class="dv">3</span>))</span>
<span id="cb40-4"><a href="time-series-data-analysis-regression.html#cb40-4" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span><span class="fu">glm</span>(death2 <span class="sc">~</span> cb1.pm<span class="sc">+</span>x<span class="sc">+</span>event , </span>
<span id="cb40-5"><a href="time-series-data-analysis-regression.html#cb40-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">family=</span>gaussian )</span>
<span id="cb40-6"><a href="time-series-data-analysis-regression.html#cb40-6" aria-hidden="true" tabindex="-1"></a>pred1.pm <span class="ot">&lt;-</span><span class="fu">crosspred</span>(cb1.pm, model1, <span class="at">at=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">100</span>, <span class="at">bylag=</span><span class="fl">0.1</span>, <span class="at">cumul=</span><span class="cn">TRUE</span>)</span>
<span id="cb40-7"><a href="time-series-data-analysis-regression.html#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="time-series-data-analysis-regression.html#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred1.pm, <span class="st">&quot;slices&quot;</span>, <span class="at">var=</span><span class="dv">1</span>, <span class="at">col=</span><span class="dv">3</span>, <span class="at">ylab=</span><span class="st">&quot;RR&quot;</span>, <span class="at">ci.arg=</span><span class="fu">list</span>(<span class="at">density=</span><span class="dv">15</span>,<span class="at">lwd=</span><span class="dv">2</span>),</span>
<span id="cb40-9"><a href="time-series-data-analysis-regression.html#cb40-9" aria-hidden="true" tabindex="-1"></a>     <span class="co">#cumul = TRUE,</span></span>
<span id="cb40-10"><a href="time-series-data-analysis-regression.html#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="at">main=</span><span class="st">&quot;Association with a 1-unit increase in PM10&quot;</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/dlnm%20plot%201-1.png" width="672" /></p>
<blockquote>
<p>The <span class="math inline">\(\beta\)</span> is highest at 6 days lag.<br />
Now we know we can do a regression analysis with 6 days as the lag time. All that’s left is to discuss further how to find time-series elements, how to correct them, and how to rationalize this process. <br></p>
</blockquote>
</div>
</div>
<div id="case-study-influenza-epidemic-and-suicide" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> case study: influenza epidemic and suicide</h2>
<p>This time, let’s talk about the flu epidemic and suicide. Suicide during flu treatment was on the news in Japan several years ago, and we would like to analyze whether it is a matter of the seasonal factor, which is the season when the flu is mainly prevalent, or whether suicide occurs when there is a really big flu epidemic.</p>
<div id="실습-데이터" class="section level3" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> 실습 데이터</h3>
<p>첫번째 실습 데이터는 감염병 포탈의 인플루엔자 자료입니다. 여기서 다운로드 합니다.</p>
<div class="figure">
<img src="img/influenza1.png" alt="" />
<p class="caption">인플루엔자</p>
</div>
<p>두번째 실습 자료는 통계청 사망자료 입니다.</p>
<div class="figure">
<img src="img/influenza2.png" alt="" />
<p class="caption">인플루엔자</p>
</div>
<p>이 둘을 합해 놓은 자료는 아래에 있습니다.</p>
<p>이것을 data 폴더에 넣겠습니다.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="time-series-data-analysis-regression.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(<span class="st">&#39;gsheet&#39;</span>)) <span class="fu">install.packages</span>(<span class="st">&#39;gsheet&#39;</span>)</span>
<span id="cb41-2"><a href="time-series-data-analysis-regression.html#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gsheet)</span>
<span id="cb41-3"><a href="time-series-data-analysis-regression.html#cb41-3" aria-hidden="true" tabindex="-1"></a>flusui <span class="ot">&lt;-</span> <span class="fu">gsheet2tbl</span>(<span class="st">&#39;docs.google.com/spreadsheets/d/14w0m545SQcrV5YYaHoPfLR3DPcWPqzwleNt-dpdC8so&#39;</span>)</span></code></pre></div>
<p>라이브러리를 불러오겠습니다.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="time-series-data-analysis-regression.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;dplyr&#39;</span>)</span>
<span id="cb42-2"><a href="time-series-data-analysis-regression.html#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;lubridate&#39;</span>)</span>
<span id="cb42-3"><a href="time-series-data-analysis-regression.html#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;mgcv&#39;</span>)</span>
<span id="cb42-4"><a href="time-series-data-analysis-regression.html#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;dlnm&#39;</span>)</span>
<span id="cb42-5"><a href="time-series-data-analysis-regression.html#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;gam&#39;</span>)</span>
<span id="cb42-6"><a href="time-series-data-analysis-regression.html#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;forecast&#39;</span>)</span>
<span id="cb42-7"><a href="time-series-data-analysis-regression.html#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&#39;Hmisc&#39;</span>)</span></code></pre></div>
<p>데이터를 살펴보면 ymd 는 숫자 형식의 날짜 (기준 1970년 1월 1일), <code>wsui</code> 는 1주간의 자살 사망자 수, <code>ordweek</code> 는 주중 순위, <code>flu</code> 는 주중 천명당 인플루엔자 환자 수.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="time-series-data-analysis-regression.html#cb43-1" aria-hidden="true" tabindex="-1"></a>data0 <span class="ot">=</span> flusui</span>
<span id="cb43-2"><a href="time-series-data-analysis-regression.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data0)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##     ymd  wsui ordweek ymd2         nwd    YR   flu
##   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 12660   238      35 2004-08-30    36  2004   0.6
## 2 12667   211      36 2004-09-06    37  2004   2  
## 3 12674   208      37 2004-09-13    38  2004   2.1
## 4 12681   188      38 2004-09-20    39  2004   2.2
## 5 12688   213      39 2004-09-27    40  2004   2.5
## 6 12695   224      40 2004-10-04    41  2004   2.4</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="time-series-data-analysis-regression.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(data0<span class="sc">$</span>wsui)</span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>신종 플루가 2009년부터 유행했고, 이후 자살자가 관련있다는 뉴스가 나오고 있으니, 2009년 전과 후를 나타내는 변수를 만들겠습니다 .</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="time-series-data-analysis-regression.html#cb46-1" aria-hidden="true" tabindex="-1"></a>myd<span class="ot">&lt;-</span>data0 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Change=</span><span class="fu">ifelse</span>(YR<span class="sc">&gt;</span><span class="dv">2008</span>, <span class="st">&quot;from 2009&quot;</span>, <span class="st">&quot;before 2009&quot;</span>))</span></code></pre></div>
<p>자료가 시계열 자료라는 것을 컴퓨터에게 알려줄 필요가 있습니다. 그리고 싸이클이 있다는 것도요. 우리는 주당 싸이클 (7일 기준)이기 때문에 <code>frequency=365.25/7</code>을 이용하고 시작 날짜를 정해줍니다.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="time-series-data-analysis-regression.html#cb47-1" aria-hidden="true" tabindex="-1"></a>tsui <span class="ot">&lt;-</span><span class="fu">ts</span>(myd<span class="sc">$</span>wsui, <span class="at">frequency=</span><span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span>, <span class="at">start =</span> <span class="fu">decimal_date</span>(<span class="fu">ymd</span>(<span class="st">&quot;2004-08-30&quot;</span>)))</span>
<span id="cb47-2"><a href="time-series-data-analysis-regression.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(myd<span class="sc">$</span>wsui)</span></code></pre></div>
<pre><code>## [1] 696</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="time-series-data-analysis-regression.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(tsui)</span></code></pre></div>
<pre><code>## [1] 696</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="time-series-data-analysis-regression.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tsui)</span></code></pre></div>
<p><img src="methods_files/figure-html/first%20ts%201-1.png" width="672" /></p>
<p>여기서 시계열적 요소를 찾아 보겠습니다.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="time-series-data-analysis-regression.html#cb52-1" aria-hidden="true" tabindex="-1"></a>d.tsui <span class="ot">&lt;-</span><span class="fu">decompose</span>(tsui)</span>
<span id="cb52-2"><a href="time-series-data-analysis-regression.html#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co">#d.tsui</span></span>
<span id="cb52-3"><a href="time-series-data-analysis-regression.html#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d.tsui) <span class="do">####### find seasonal and trend</span></span></code></pre></div>
<p><img src="methods_files/figure-html/decomposition%20ts%201-1.png" width="672" /></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="time-series-data-analysis-regression.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(d.tsui<span class="sc">$</span>random)</span></code></pre></div>
<pre><code>##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.     NA&#39;s 
## -78.1819 -18.8440  -0.3562   1.2124  18.5710 175.0412       51</code></pre>
<p>이번에는 flu에 대한 시계열 분석을 해보겠습니다.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="time-series-data-analysis-regression.html#cb55-1" aria-hidden="true" tabindex="-1"></a>r.tsui <span class="ot">&lt;-</span>d.tsui<span class="sc">$</span>random <span class="co"># residuals</span></span>
<span id="cb55-2"><a href="time-series-data-analysis-regression.html#cb55-2" aria-hidden="true" tabindex="-1"></a>s.tsui <span class="ot">&lt;-</span>d.tsui<span class="sc">$</span>seasonal <span class="co"># seasonal</span></span>
<span id="cb55-3"><a href="time-series-data-analysis-regression.html#cb55-3" aria-hidden="true" tabindex="-1"></a>tr.tsui <span class="ot">&lt;-</span>d.tsui<span class="sc">$</span>trend <span class="co"># long term trend</span></span>
<span id="cb55-4"><a href="time-series-data-analysis-regression.html#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="do">######### influenza&#39;</span></span>
<span id="cb55-5"><a href="time-series-data-analysis-regression.html#cb55-5" aria-hidden="true" tabindex="-1"></a>tflu <span class="ot">&lt;-</span><span class="fu">ts</span>(myd<span class="sc">$</span>flu, <span class="at">frequency=</span><span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span>, <span class="at">start =</span> <span class="fu">decimal_date</span>(<span class="fu">ymd</span>(<span class="st">&quot;2004-08-30&quot;</span>)))</span>
<span id="cb55-6"><a href="time-series-data-analysis-regression.html#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tflu)</span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-12-1.png" width="672" />
이것을 decomposition 하면</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="time-series-data-analysis-regression.html#cb56-1" aria-hidden="true" tabindex="-1"></a>d.tflu <span class="ot">&lt;-</span><span class="fu">decompose</span>(tflu)</span>
<span id="cb56-2"><a href="time-series-data-analysis-regression.html#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d.tflu) <span class="do">####### find seasonal and trend</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="time-series-data-analysis-regression.html#cb57-1" aria-hidden="true" tabindex="-1"></a>r.tflu <span class="ot">&lt;-</span>d.tflu<span class="sc">$</span>random <span class="co"># residuals</span></span>
<span id="cb57-2"><a href="time-series-data-analysis-regression.html#cb57-2" aria-hidden="true" tabindex="-1"></a>s.tflu <span class="ot">&lt;-</span>d.tflu<span class="sc">$</span>seasonal <span class="co"># seasonal</span></span>
<span id="cb57-3"><a href="time-series-data-analysis-regression.html#cb57-3" aria-hidden="true" tabindex="-1"></a>tr.tflu <span class="ot">&lt;-</span>d.tflu<span class="sc">$</span>trend <span class="co"># long term trend</span></span></code></pre></div>
</div>
<div id="simple-time-related-variable-adjusting-regression" class="section level3" number="3.4.2">
<h3><span class="header-section-number">3.4.2</span> simple time-related variable adjusting regression</h3>
<p>결국 resudial flu와 residual sui의 상관관계를 보면 되는 것이라고 생각해 봅시다.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="time-series-data-analysis-regression.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Hmisc)</span>
<span id="cb58-2"><a href="time-series-data-analysis-regression.html#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r.tflu, r.tsui)</span>
<span id="cb58-3"><a href="time-series-data-analysis-regression.html#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> r.tflu))</span></code></pre></div>
<p><img src="methods_files/figure-html/nolagmodel-1.png" width="672" /></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="time-series-data-analysis-regression.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>), r.tsui)</span>
<span id="cb59-2"><a href="time-series-data-analysis-regression.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>)))</span></code></pre></div>
<p><img src="methods_files/figure-html/nolagmodel-2.png" width="672" /></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="time-series-data-analysis-regression.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb60-2"><a href="time-series-data-analysis-regression.html#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r.tflu, r.tsui, <span class="at">cex=</span><span class="fl">0.2</span>, <span class="at">main=</span><span class="st">&quot;no lag model&quot;</span>)</span>
<span id="cb60-3"><a href="time-series-data-analysis-regression.html#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> r.tflu))</span>
<span id="cb60-4"><a href="time-series-data-analysis-regression.html#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">15</span>, <span class="dv">130</span>, <span class="st">&#39;Beta =&#39;</span>)</span>
<span id="cb60-5"><a href="time-series-data-analysis-regression.html#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">15</span>, <span class="dv">100</span>, <span class="st">&#39;P value=&#39;</span>)</span>
<span id="cb60-6"><a href="time-series-data-analysis-regression.html#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">30</span>, <span class="dv">130</span>, <span class="fu">round</span>(<span class="fu">summary</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">0</span>)))<span class="sc">$</span>coefficients[<span class="fu">c</span>(<span class="dv">2</span>)], <span class="dv">4</span>))</span>
<span id="cb60-7"><a href="time-series-data-analysis-regression.html#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">30</span>, <span class="dv">100</span>, <span class="fu">round</span>(<span class="fu">summary</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">0</span>)))<span class="sc">$</span>coefficients[<span class="fu">c</span>(<span class="dv">8</span>)], <span class="dv">4</span>))</span>
<span id="cb60-8"><a href="time-series-data-analysis-regression.html#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="time-series-data-analysis-regression.html#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>), r.tsui, <span class="at">cex=</span><span class="fl">0.2</span>, <span class="at">main=</span><span class="st">&quot;3 weeks lag model&quot;</span>)</span>
<span id="cb60-10"><a href="time-series-data-analysis-regression.html#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>)))</span>
<span id="cb60-11"><a href="time-series-data-analysis-regression.html#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">15</span>, <span class="dv">130</span>, <span class="st">&#39;Beta =&#39;</span>)</span>
<span id="cb60-12"><a href="time-series-data-analysis-regression.html#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">15</span>, <span class="dv">100</span>, <span class="st">&#39;P value=&#39;</span>)</span>
<span id="cb60-13"><a href="time-series-data-analysis-regression.html#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">30</span>, <span class="dv">130</span>, <span class="fu">round</span>(<span class="fu">summary</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>)))<span class="sc">$</span>coefficients[<span class="fu">c</span>(<span class="dv">2</span>)], <span class="dv">3</span>))</span>
<span id="cb60-14"><a href="time-series-data-analysis-regression.html#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="dv">30</span>, <span class="dv">100</span>, <span class="fu">round</span>(<span class="fu">summary</span>(<span class="fu">lm</span>(r.tsui <span class="sc">~</span> <span class="fu">Lag</span>(r.tflu, <span class="dv">3</span>)))<span class="sc">$</span>coefficients[<span class="fu">c</span>(<span class="dv">8</span>)], <span class="dv">3</span>))</span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-14-1.png" width="672" />
### ARIMA</p>
<p>What we can do in this course
Date and Time formatting
Data pre-processing (class <code>ts</code>, cleaning, missing data, outlier)
Statistical Traits of Times series (Autocorrelation, stationarity, seasonality, trend)</p>
<table>
<thead>
<tr class="header">
<th align="left">steps</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Date and Time Formatting</td>
</tr>
<tr class="even">
<td align="left">Data Pre Processing</td>
</tr>
<tr class="odd">
<td align="left">Statistical Traits of Time Series</td>
</tr>
<tr class="even">
<td align="left">Standard Models</td>
</tr>
<tr class="odd">
<td align="left">ARIMA Models</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="analysis-and-forecasting-regression" class="section level2" number="3.5">
<h2><span class="header-section-number">3.5</span> analysis and forecasting, regression</h2>
<p>Time series analysis is analyzing the data to find patterns, forecasting is extrapolating the patterns into the future, regression with time series pattern (time series regression) is regression method using time series analysis.</p>
</div>
<div id="arima" class="section level2" number="3.6">
<h2><span class="header-section-number">3.6</span> ARIMA</h2>
<p>ARIMA (autoregressive intergrated moving average) 는 문자 그대로 자기상관관계와 이동평균을 이용합니다. univariate time series로 보시면 됩니다. ARIMA 모델에서 여러 파라메터를 자동으로 또는 수동으로 설정하여 구성해 가게 됩니다. <br></p>
<hr />
<p><strong><code>ARIMA(p, d, q)</code></strong>를 이해하면서 가 봅겠습니다. <br></p>
<table>
<thead>
<tr class="header">
<th align="left">parameter</th>
<th align="left">content</th>
<th align="left">abbr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">AR</td>
<td align="left">Autoregressive part</td>
<td align="left"><strong>p</strong></td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">Integrateion, degree of differencing</td>
<td align="left"><strong>d</strong></td>
</tr>
<tr class="odd">
<td align="left">MA</td>
<td align="left">Moving average part</td>
<td align="left"><strong>q</strong></td>
</tr>
</tbody>
</table>
<p>위 에서 <code>p, d, q</code>를 찾아 가는 방법을 ARIMA 모델이라고 부를 수 있습니다.</p>
<blockquote>
<p>lags 과 forecasting errors로 구분할 수 있습니다.</p>
</blockquote>
<ul>
<li>과거의 변수가 현재를 예측, autoregressive part
<ul>
<li>AR(1) or ARIMA(1,0,0): first order (lag) of AR</li>
<li>AR(2) or ARIMA(2,0,0): second order (lag) of AR
<br></li>
</ul></li>
<li>과거의 error 가 현재를 예측 (forecasting error) = moving average part
<ul>
<li>MA(1) or ARIMA(0,0,1): first order of MA</li>
<li>MA(2) or ARIMA(0,0,2): second order of MA</li>
</ul></li>
</ul>
<blockquote>
<p>자기상관관계 부분</p>
</blockquote>
<p><span class="math display">\[ Y_{t} = c + \Phi_1 Y_{t-1} + \varepsilon_{t} \]</span></p>
<ul>
<li><span class="math inline">\(t\)</span> 시간에 관찰되는 변수 (<span class="math inline">\(Y_{t}\)</span>)는
<ul>
<li>상수 (c) 더하기</li>
<li>바로 1단위 전 변수 (<span class="math inline">\(Y_{t-1}\)</span>) 에 계수(coefficient) (<span class="math inline">\(\Phi\)</span>) 글 곱한 값을 더하고</li>
<li>현재의 에러를 <span class="math inline">\(t (e_{t})\)</span>) 더한다</li>
</ul></li>
</ul>
<blockquote>
<p>이동평균 부분</p>
</blockquote>
<p><span class="math display">\[ Y_{t} = c  + \Theta_1 \varepsilon_{t-1} + \varepsilon_t \]</span></p>
<ul>
<li><span class="math inline">\(t\)</span> 시간에 관찰되는 변수 (<span class="math inline">\(Y_{t}\)</span>)는
<ul>
<li>상수 (c) 더하기</li>
<li>바로 1단위 전 변수 (<span class="math inline">\(\varepsilon_{t-1}\)</span>) 에 계수(coefficient) (<span class="math inline">\(\Phi\)</span>) 글 곱한 값을 더하고</li>
<li>현재의 에러를 <span class="math inline">\(t (e_{t})\)</span>) 더한다</li>
</ul></li>
</ul>
<blockquote>
<p>결국 자기 상과관계와 이동평균을 한꺼번에 사용하면 아래와 같습니다.</p>
</blockquote>
<p><span class="math display">\[\begin{align*}
y_t &amp;= \phi_1y_{t-1} + \varepsilon_t\\
&amp;= \phi_1(\phi_1y_{t-2} + \varepsilon_{t-1}) + \varepsilon_t\\
&amp;= \phi_1^2y_{t-2} + \phi_1 \varepsilon_{t-1} + \varepsilon_t\\
&amp;= \phi_1^3y_{t-3} + \phi_1^2 \varepsilon_{t-2} + \phi_1 \varepsilon_{t-1} + \varepsilon_t\\
\end{align*}\]</span></p>
<blockquote>
<p>d 는 시계열그림에서 ACF, PACF의 형태를 보고 차분의 필요여부
및 차수를 d를 결정하고 AR차수와 MA차수를 결정</p>
</blockquote>
<p>어떻게 <strong>p, d, q</strong> 를 구할수 있을 까요?, 다음 장을 보겠습니다.
** 다음에 기회가 있을 때 하겠습니다.**</p>
<div id="arima-감기-자살-aic" class="section level3" number="3.6.1">
<h3><span class="header-section-number">3.6.1</span> arima 감기 자살 , AIC</h3>
<p>아래 ARIMA 모델을 보면 AIC 가 6583정도 나온 것을 알 수 있습니다. 우리는 이것을 통해 AIC가 6583 이하 정도 나오는 gam 모델을 사용하겠다 정도의 개념을 얻었습니다.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="time-series-data-analysis-regression.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb61-2"><a href="time-series-data-analysis-regression.html#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(myd<span class="sc">$</span>wsui)</span></code></pre></div>
<pre><code>## Series: myd$wsui 
## ARIMA(0,1,2) 
## 
## Coefficients:
##           ma1      ma2
##       -0.3227  -0.0993
## s.e.   0.0379   0.0376
## 
## sigma^2 estimated as 756.3:  log likelihood=-3288.64
## AIC=6583.28   AICc=6583.31   BIC=6596.91</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="time-series-data-analysis-regression.html#cb63-1" aria-hidden="true" tabindex="-1"></a>myd <span class="ot">&lt;-</span>myd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ma4 =</span><span class="fu">ma</span>(wsui, <span class="at">order=</span><span class="dv">4</span>), <span class="at">ymd2=</span><span class="fu">as.Date</span>(ymd2) ) <span class="do">### 4weeks moving average</span></span>
<span id="cb63-2"><a href="time-series-data-analysis-regression.html#cb63-2" aria-hidden="true" tabindex="-1"></a>myd <span class="ot">&lt;-</span>myd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ts.wsui =</span>tsui, <span class="at">ts.ma4=</span><span class="fu">ts</span>(ma4, <span class="at">frequency =</span><span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span> ))</span>
<span id="cb63-3"><a href="time-series-data-analysis-regression.html#cb63-3" aria-hidden="true" tabindex="-1"></a>m1<span class="ot">&lt;-</span><span class="fu">arima</span>(myd<span class="sc">$</span>wsui, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">fixed=</span><span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>)) <span class="do">## NA means include, 0 means exclude</span></span>
<span id="cb63-4"><a href="time-series-data-analysis-regression.html#cb63-4" aria-hidden="true" tabindex="-1"></a>m1</span></code></pre></div>
<pre><code>## 
## Call:
## arima(x = myd$wsui, order = c(1, 1, 1), fixed = c(NA, NA))
## 
## Coefficients:
##          ar1      ma1
##       0.2294  -0.5589
## s.e.  0.0941   0.0797
## 
## sigma^2 estimated as 755.2:  log likelihood = -3289.13,  aic = 6584.26</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="time-series-data-analysis-regression.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tsdiag</span>(m1)</span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
</div>
</div>
<div id="aic-bic-in-generalize-additive-model" class="section level2" number="3.7">
<h2><span class="header-section-number">3.7</span> AIC BIC in generalize additive model</h2>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="time-series-data-analysis-regression.html#cb66-1" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb66-2"><a href="time-series-data-analysis-regression.html#cb66-2" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">ns</span>(ymd2, x))</span>
<span id="cb66-3"><a href="time-series-data-analysis-regression.html#cb66-3" aria-hidden="true" tabindex="-1"></a>  aic <span class="ot">&lt;-</span><span class="fu">AIC</span>(model)</span>
<span id="cb66-4"><a href="time-series-data-analysis-regression.html#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aic)</span>
<span id="cb66-5"><a href="time-series-data-analysis-regression.html#cb66-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-6"><a href="time-series-data-analysis-regression.html#cb66-6" aria-hidden="true" tabindex="-1"></a>gg2 <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb66-7"><a href="time-series-data-analysis-regression.html#cb66-7" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">ns</span>(ymd2, x))</span>
<span id="cb66-8"><a href="time-series-data-analysis-regression.html#cb66-8" aria-hidden="true" tabindex="-1"></a>  bic <span class="ot">&lt;-</span><span class="fu">BIC</span>(model)</span>
<span id="cb66-9"><a href="time-series-data-analysis-regression.html#cb66-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bic)</span>
<span id="cb66-10"><a href="time-series-data-analysis-regression.html#cb66-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-11"><a href="time-series-data-analysis-regression.html#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="time-series-data-analysis-regression.html#cb66-12" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="dv">50</span><span class="sc">:</span><span class="dv">100</span>), gg);test2<span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="dv">50</span><span class="sc">:</span><span class="dv">100</span>), gg2)</span>
<span id="cb66-13"><a href="time-series-data-analysis-regression.html#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="time-series-data-analysis-regression.html#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb66-15"><a href="time-series-data-analysis-regression.html#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">c</span>(<span class="dv">50</span><span class="sc">:</span><span class="dv">100</span>), test);<span class="fu">plot</span>(<span class="fu">c</span>(<span class="dv">50</span><span class="sc">:</span><span class="dv">100</span>), test2)</span>
<span id="cb66-16"><a href="time-series-data-analysis-regression.html#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="dv">64</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>AIC는 수렴하지 않아 어렵고, BIC는 64에서 최소 값을 보이네요. 64를 자유도로 선정하고 수행하겠습니다.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="time-series-data-analysis-regression.html#cb67-1" aria-hidden="true" tabindex="-1"></a>mod1<span class="ot">&lt;-</span><span class="fu">glm</span> (wsui <span class="sc">~</span> <span class="fu">ns</span>(ymd2, <span class="dv">64</span>), <span class="at">data=</span>myd)</span>
<span id="cb67-2"><a href="time-series-data-analysis-regression.html#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(mod1)</span></code></pre></div>
<pre><code>## [1] 6790.573</code></pre>
<p>long term trend (월)과 단기 trend 를 나누어 만들어 보면 어떨까요? 위에 64로 한번에 해결하는 게 더 좋은 모형 같습니다.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="time-series-data-analysis-regression.html#cb69-1" aria-hidden="true" tabindex="-1"></a>mod1<span class="ot">&lt;-</span><span class="fu">glm</span>( wsui <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">12</span>)<span class="sc">+</span><span class="fu">ns</span>(nwd, <span class="dv">5</span>), <span class="at">data=</span>myd)</span>
<span id="cb69-2"><a href="time-series-data-analysis-regression.html#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(mod1)</span></code></pre></div>
<pre><code>## [1] 6907.866</code></pre>
<p>기존의 sin cosin 방법으로 시계열 분석을 해보는 것은 어떨까요?</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="time-series-data-analysis-regression.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb71-2"><a href="time-series-data-analysis-regression.html#cb71-2" aria-hidden="true" tabindex="-1"></a>ssp<span class="ot">&lt;-</span><span class="fu">spectrum</span>(myd<span class="sc">$</span>wsui)</span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="time-series-data-analysis-regression.html#cb72-1" aria-hidden="true" tabindex="-1"></a>per<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">/</span>ssp<span class="sc">$</span>freq[ssp<span class="sc">$</span>spec<span class="sc">==</span><span class="fu">max</span>(ssp<span class="sc">$</span>spec)]</span>
<span id="cb72-2"><a href="time-series-data-analysis-regression.html#cb72-2" aria-hidden="true" tabindex="-1"></a>sin.x<span class="ot">&lt;-</span><span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>myd<span class="sc">$</span>ordweek<span class="sc">/</span>(<span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span>))</span>
<span id="cb72-3"><a href="time-series-data-analysis-regression.html#cb72-3" aria-hidden="true" tabindex="-1"></a>cos.x<span class="ot">&lt;-</span><span class="fu">cos</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>myd<span class="sc">$</span>ordweek<span class="sc">/</span>(<span class="fl">365.25</span><span class="sc">/</span><span class="dv">7</span>))</span>
<span id="cb72-4"><a href="time-series-data-analysis-regression.html#cb72-4" aria-hidden="true" tabindex="-1"></a>modsean <span class="ot">&lt;-</span><span class="fu">glm</span>(wsui <span class="sc">~</span> <span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>), <span class="at">data=</span>myd)</span>
<span id="cb72-5"><a href="time-series-data-analysis-regression.html#cb72-5" aria-hidden="true" tabindex="-1"></a>modlgam<span class="ot">&lt;-</span><span class="fu">glm</span>(wsui <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">4</span>), <span class="at">data=</span>myd)</span>
<span id="cb72-6"><a href="time-series-data-analysis-regression.html#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="time-series-data-analysis-regression.html#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myd<span class="sc">$</span>ymd2, myd<span class="sc">$</span>wsui, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">450</span>), <span class="at">col=</span><span class="st">&#39;grey&#39;</span>)</span>
<span id="cb72-8"><a href="time-series-data-analysis-regression.html#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modlgam<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">&#39;l&#39;</span>, <span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb72-9"><a href="time-series-data-analysis-regression.html#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modsean<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">&#39;l&#39;</span>, <span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-19-2.png" width="672" /></p>
<p>자 이제 2 모델을 검토해 보겠습니다. gam 과 sin cosin 모델 어떤게 더 좋아 보이시나요? 정해진 규칙은 겂습니다.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="time-series-data-analysis-regression.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myd<span class="sc">$</span>ymd2, myd<span class="sc">$</span>wsui, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">10</span>, <span class="dv">450</span>), <span class="at">col=</span><span class="st">&#39;grey&#39;</span>)</span>
<span id="cb73-2"><a href="time-series-data-analysis-regression.html#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modlgam<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">&#39;l&#39;</span>, <span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb73-3"><a href="time-series-data-analysis-regression.html#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modsean<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">&#39;l&#39;</span>, <span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb73-4"><a href="time-series-data-analysis-regression.html#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="time-series-data-analysis-regression.html#cb73-5" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span><span class="fu">glm</span>(wsui <span class="sc">~</span> flu<span class="sc">+</span><span class="fu">ns</span>(ordweek, <span class="dv">51</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>) , <span class="at">data=</span>myd)</span>
<span id="cb73-6"><a href="time-series-data-analysis-regression.html#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, mod1<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">&#39;l&#39;</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb73-7"><a href="time-series-data-analysis-regression.html#cb73-7" aria-hidden="true" tabindex="-1"></a>modgam<span class="ot">&lt;-</span><span class="fu">glm</span> (wsui <span class="sc">~</span> <span class="fu">ns</span>(ymd2, <span class="dv">64</span>), <span class="at">data=</span>myd)</span>
<span id="cb73-8"><a href="time-series-data-analysis-regression.html#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, modgam<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">&#39;l&#39;</span>,  <span class="at">col=</span><span class="st">&#39;black&#39;</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/comp1-1.png" width="672" />
정해진 규칙은 없지만 AIC와 BIC로 비교해 볼수 있을 것 같습니다.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="time-series-data-analysis-regression.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(mod1);<span class="fu">AIC</span>(modgam)</span></code></pre></div>
<pre><code>## [1] 6522.669</code></pre>
<pre><code>## [1] 6490.58</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="time-series-data-analysis-regression.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(mod1);<span class="fu">BIC</span>(modgam)</span></code></pre></div>
<pre><code>## [1] 6786.299</code></pre>
<pre><code>## [1] 6790.573</code></pre>
<p>이제 sin과 cos 에 어떠한 df를 주는 것이 좋을 까요?</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="time-series-data-analysis-regression.html#cb80-1" aria-hidden="true" tabindex="-1"></a>myd<span class="sc">$</span>econo <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(myd<span class="sc">$</span>YR <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2009</span>), <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb80-2"><a href="time-series-data-analysis-regression.html#cb80-2" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb80-3"><a href="time-series-data-analysis-regression.html#cb80-3" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">Lag</span>(flu, <span class="dv">1</span>)<span class="sc">+</span><span class="fu">ns</span>(ordweek, <span class="dv">4</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, x)<span class="sc">+</span><span class="fu">ns</span>(cos.x, x))</span>
<span id="cb80-4"><a href="time-series-data-analysis-regression.html#cb80-4" aria-hidden="true" tabindex="-1"></a>  aic <span class="ot">&lt;-</span><span class="fu">AIC</span>(model)</span>
<span id="cb80-5"><a href="time-series-data-analysis-regression.html#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aic)</span>
<span id="cb80-6"><a href="time-series-data-analysis-regression.html#cb80-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-7"><a href="time-series-data-analysis-regression.html#cb80-7" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb80-8"><a href="time-series-data-analysis-regression.html#cb80-8" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">Lag</span>(flu, <span class="dv">1</span>)<span class="sc">+</span><span class="fu">ns</span>(ordweek, <span class="dv">4</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, x)<span class="sc">+</span><span class="fu">ns</span>(cos.x, x))</span>
<span id="cb80-9"><a href="time-series-data-analysis-regression.html#cb80-9" aria-hidden="true" tabindex="-1"></a>  bic <span class="ot">&lt;-</span><span class="fu">BIC</span>(model)</span>
<span id="cb80-10"><a href="time-series-data-analysis-regression.html#cb80-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bic)</span>
<span id="cb80-11"><a href="time-series-data-analysis-regression.html#cb80-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-12"><a href="time-series-data-analysis-regression.html#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="time-series-data-analysis-regression.html#cb80-13" aria-hidden="true" tabindex="-1"></a>p<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb80-14"><a href="time-series-data-analysis-regression.html#cb80-14" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span>p, gg);test2<span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span>p, gg2)</span>
<span id="cb80-15"><a href="time-series-data-analysis-regression.html#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test)</span></code></pre></div>
<p><img src="methods_files/figure-html/comp2-1.png" width="672" /></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="time-series-data-analysis-regression.html#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test2)</span></code></pre></div>
<p><img src="methods_files/figure-html/comp2-2.png" width="672" /></p>
<p>주중 효과 까지 한번 보겠습니다.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="time-series-data-analysis-regression.html#cb82-1" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb82-2"><a href="time-series-data-analysis-regression.html#cb82-2" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">Lag</span>(flu, <span class="dv">1</span>)<span class="sc">+</span> <span class="fu">ns</span>(ordweek, x)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb82-3"><a href="time-series-data-analysis-regression.html#cb82-3" aria-hidden="true" tabindex="-1"></a>  aic <span class="ot">&lt;-</span><span class="fu">AIC</span>(model)</span>
<span id="cb82-4"><a href="time-series-data-analysis-regression.html#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aic)</span>
<span id="cb82-5"><a href="time-series-data-analysis-regression.html#cb82-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-6"><a href="time-series-data-analysis-regression.html#cb82-6" aria-hidden="true" tabindex="-1"></a>gg2 <span class="ot">&lt;-</span><span class="cf">function</span>(x) {</span>
<span id="cb82-7"><a href="time-series-data-analysis-regression.html#cb82-7" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> <span class="fu">Lag</span>(flu, <span class="dv">1</span>)<span class="sc">+</span><span class="fu">ns</span>(ordweek, x)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb82-8"><a href="time-series-data-analysis-regression.html#cb82-8" aria-hidden="true" tabindex="-1"></a>  bic <span class="ot">&lt;-</span><span class="fu">BIC</span>(model)</span>
<span id="cb82-9"><a href="time-series-data-analysis-regression.html#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bic)</span>
<span id="cb82-10"><a href="time-series-data-analysis-regression.html#cb82-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-11"><a href="time-series-data-analysis-regression.html#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="fu">gg</span>(<span class="dv">10</span>)</span></code></pre></div>
<pre><code>## [1] 6855.118</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="time-series-data-analysis-regression.html#cb84-1" aria-hidden="true" tabindex="-1"></a>test</span></code></pre></div>
<pre><code>##  [1] 7024.946 6937.616 6938.160 6949.544 6962.157 6964.344 6983.018 6988.755
##  [9] 6998.796 7012.950</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="time-series-data-analysis-regression.html#cb86-1" aria-hidden="true" tabindex="-1"></a>p<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">100</span>)</span>
<span id="cb86-2"><a href="time-series-data-analysis-regression.html#cb86-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span>p, gg);test2<span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">x=</span>p, gg2)</span>
<span id="cb86-3"><a href="time-series-data-analysis-regression.html#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb86-4"><a href="time-series-data-analysis-regression.html#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test)</span>
<span id="cb86-5"><a href="time-series-data-analysis-regression.html#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="dv">39</span>)</span>
<span id="cb86-6"><a href="time-series-data-analysis-regression.html#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test2)</span>
<span id="cb86-7"><a href="time-series-data-analysis-regression.html#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="dv">39</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/mod4-1.png" width="672" /></p>
<p>최종 모델은 아래와 같습니다.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="time-series-data-analysis-regression.html#cb87-1" aria-hidden="true" tabindex="-1"></a>mod2 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> flu<span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">39</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb87-2"><a href="time-series-data-analysis-regression.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb87-3"><a href="time-series-data-analysis-regression.html#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myd<span class="sc">$</span>ymd2, myd<span class="sc">$</span>wsui, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">col=</span><span class="st">&#39;grey&#39;</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">50</span>, <span class="dv">450</span>))</span>
<span id="cb87-4"><a href="time-series-data-analysis-regression.html#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(myd<span class="sc">$</span>ymd2, mod2<span class="sc">$</span>fitted.values, <span class="at">type=</span><span class="st">&#39;l&#39;</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span></code></pre></div>
<p><img src="methods_files/figure-html/mod5-1.png" width="672" /></p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="time-series-data-analysis-regression.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(mod2)</span></code></pre></div>
<pre><code>## [1] 6785.09</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="time-series-data-analysis-regression.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(mod2)</span></code></pre></div>
<pre><code>## [1] 6576.004</code></pre>
<p>그럼 이제 lag time 을 non-linear 로 할때 몇차 방정식이 좋을까요? 둘다 2차 방정식이 좋네요</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="time-series-data-analysis-regression.html#cb92-1" aria-hidden="true" tabindex="-1"></a>gg3<span class="ot">&lt;-</span><span class="cf">function</span>(pp){</span>
<span id="cb92-2"><a href="time-series-data-analysis-regression.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  cb<span class="ot">&lt;-</span> <span class="fu">crossbasis</span>(myd<span class="sc">$</span>flu<span class="sc">/</span><span class="dv">10</span>, <span class="at">lag=</span><span class="dv">24</span>, <span class="at">argvar=</span><span class="fu">list</span>(<span class="st">&quot;lin&quot;</span>),  <span class="at">arglag =</span> <span class="fu">list</span>(<span class="at">fun=</span><span class="st">&quot;poly&quot;</span>, <span class="at">degree=</span>pp))</span>
<span id="cb92-3"><a href="time-series-data-analysis-regression.html#cb92-3" aria-hidden="true" tabindex="-1"></a>  model<span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> cb <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">39</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb92-4"><a href="time-series-data-analysis-regression.html#cb92-4" aria-hidden="true" tabindex="-1"></a>  aic<span class="ot">&lt;-</span><span class="fu">AIC</span>(model)</span>
<span id="cb92-5"><a href="time-series-data-analysis-regression.html#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aic)</span>
<span id="cb92-6"><a href="time-series-data-analysis-regression.html#cb92-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-7"><a href="time-series-data-analysis-regression.html#cb92-7" aria-hidden="true" tabindex="-1"></a>gg4<span class="ot">&lt;-</span><span class="cf">function</span>(pp){</span>
<span id="cb92-8"><a href="time-series-data-analysis-regression.html#cb92-8" aria-hidden="true" tabindex="-1"></a>  cb1<span class="ot">&lt;-</span> <span class="fu">crossbasis</span>(myd<span class="sc">$</span>flu<span class="sc">/</span><span class="dv">10</span>, <span class="at">lag=</span><span class="dv">24</span>, <span class="at">argvar=</span><span class="fu">list</span>(<span class="st">&quot;lin&quot;</span>),  <span class="at">arglag =</span> <span class="fu">list</span>(<span class="at">fun=</span><span class="st">&quot;poly&quot;</span>, <span class="at">degree=</span>pp))</span>
<span id="cb92-9"><a href="time-series-data-analysis-regression.html#cb92-9" aria-hidden="true" tabindex="-1"></a>  model1<span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> cb1 <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">39</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>))</span>
<span id="cb92-10"><a href="time-series-data-analysis-regression.html#cb92-10" aria-hidden="true" tabindex="-1"></a>  bic<span class="ot">&lt;-</span><span class="fu">BIC</span>(model1)</span>
<span id="cb92-11"><a href="time-series-data-analysis-regression.html#cb92-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bic)</span>
<span id="cb92-12"><a href="time-series-data-analysis-regression.html#cb92-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-13"><a href="time-series-data-analysis-regression.html#cb92-13" aria-hidden="true" tabindex="-1"></a>p<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb92-14"><a href="time-series-data-analysis-regression.html#cb92-14" aria-hidden="true" tabindex="-1"></a>test3 <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">pp=</span>p, gg3);test4 <span class="ot">&lt;-</span><span class="fu">mapply</span>(<span class="at">pp=</span>p, gg4)</span>
<span id="cb92-15"><a href="time-series-data-analysis-regression.html#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb92-16"><a href="time-series-data-analysis-regression.html#cb92-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test3)</span>
<span id="cb92-17"><a href="time-series-data-analysis-regression.html#cb92-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-18"><a href="time-series-data-analysis-regression.html#cb92-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, test4)</span></code></pre></div>
<p><img src="methods_files/figure-html/ts%20simul%20lag-1.png" width="672" /></p>
<p>종합해서 나타내 보겠습니다. 이것이 첫번째 종착지 입니다.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="time-series-data-analysis-regression.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb93-2"><a href="time-series-data-analysis-regression.html#cb93-2" aria-hidden="true" tabindex="-1"></a>cb1<span class="ot">&lt;-</span> <span class="fu">crossbasis</span>(myd<span class="sc">$</span>flu<span class="sc">/</span><span class="dv">10</span>, <span class="at">lag=</span><span class="dv">24</span>, <span class="at">argvar=</span><span class="fu">list</span>(<span class="st">&quot;lin&quot;</span>),  <span class="at">arglag =</span> <span class="fu">list</span>(<span class="at">fun=</span><span class="st">&quot;poly&quot;</span>, <span class="at">degree=</span><span class="dv">2</span>))</span>
<span id="cb93-3"><a href="time-series-data-analysis-regression.html#cb93-3" aria-hidden="true" tabindex="-1"></a>model1<span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>myd, wsui <span class="sc">~</span> cb1 <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">39</span>)<span class="sc">+</span><span class="fu">ns</span>(sin.x, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cos.x, <span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb93-4"><a href="time-series-data-analysis-regression.html#cb93-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-5"><a href="time-series-data-analysis-regression.html#cb93-5" aria-hidden="true" tabindex="-1"></a>pred1.cb1 <span class="ot">&lt;-</span><span class="fu">crosspred</span>(cb1, model1, <span class="at">at=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="at">bylag=</span><span class="fl">0.1</span>,  <span class="at">cumul=</span><span class="cn">TRUE</span>)</span>
<span id="cb93-6"><a href="time-series-data-analysis-regression.html#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred1.cb1, <span class="st">&quot;slices&quot;</span>, <span class="at">var=</span><span class="dv">1</span>, <span class="at">col=</span><span class="dv">3</span>, <span class="at">ylab=</span><span class="st">&quot;Relative risk of suicide&quot;</span>, <span class="co">#ci.arg=list(density=50, lwd=1),#</span></span>
<span id="cb93-7"><a href="time-series-data-analysis-regression.html#cb93-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">&quot;Temporal effect by influenza&quot;</span>, </span>
<span id="cb93-8"><a href="time-series-data-analysis-regression.html#cb93-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">&quot;Lag (weeks)&quot;</span>,  <span class="at">family=</span><span class="st">&quot;A&quot;</span>,<span class="co">#ylim=c(0.980, 1.02),</span></span>
<span id="cb93-9"><a href="time-series-data-analysis-regression.html#cb93-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span><span class="st">&#39;black&#39;</span>) ;<span class="fu">grid</span>()</span>
<span id="cb93-10"><a href="time-series-data-analysis-regression.html#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main=</span><span class="st">&quot;% increment of influenza like illness&quot;</span>, </span>
<span id="cb93-11"><a href="time-series-data-analysis-regression.html#cb93-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">family=</span><span class="st">&quot;A&quot;</span>, </span>
<span id="cb93-12"><a href="time-series-data-analysis-regression.html#cb93-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">adj=</span><span class="dv">1</span>, <span class="at">line=</span><span class="dv">0</span>, <span class="at">font.main=</span><span class="dv">3</span>, <span class="at">cex=</span><span class="fl">0.5</span> )</span>
<span id="cb93-13"><a href="time-series-data-analysis-regression.html#cb93-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-14"><a href="time-series-data-analysis-regression.html#cb93-14" aria-hidden="true" tabindex="-1"></a>lin <span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb93-15"><a href="time-series-data-analysis-regression.html#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>lin, <span class="at">lty=</span><span class="dv">3</span>, <span class="at">col=</span><span class="st">&#39;lightgray&#39;</span>)</span>
<span id="cb93-16"><a href="time-series-data-analysis-regression.html#cb93-16" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side=</span><span class="dv">1</span>, <span class="at">at=</span><span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>))</span></code></pre></div>
<p><img src="methods_files/figure-html/ts%20regression%201-1.png" width="672" />
2009년 이전과 이후를 그려보겠습니다.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="time-series-data-analysis-regression.html#cb94-1" aria-hidden="true" tabindex="-1"></a>myd2<span class="ot">&lt;-</span>myd <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sinx=</span>sin.x, <span class="at">cosx=</span>cos.x) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">flu210=</span>flu<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb94-2"><a href="time-series-data-analysis-regression.html#cb94-2" aria-hidden="true" tabindex="-1"></a>mf1d <span class="ot">&lt;-</span>myd2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(YR <span class="sc">&lt;=</span><span class="dv">2008</span>)</span>
<span id="cb94-3"><a href="time-series-data-analysis-regression.html#cb94-3" aria-hidden="true" tabindex="-1"></a>mf2d <span class="ot">&lt;-</span>myd2 <span class="sc">%&gt;%</span> <span class="fu">filter</span> (YR<span class="sc">&gt;=</span><span class="dv">2009</span>)</span>
<span id="cb94-4"><a href="time-series-data-analysis-regression.html#cb94-4" aria-hidden="true" tabindex="-1"></a>mf1 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf1d, wsui <span class="sc">~</span> flu <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">25</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx, <span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb94-5"><a href="time-series-data-analysis-regression.html#cb94-5" aria-hidden="true" tabindex="-1"></a>mf1s<span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf1d , flu210 <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">25</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx,<span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb94-6"><a href="time-series-data-analysis-regression.html#cb94-6" aria-hidden="true" tabindex="-1"></a>b2008<span class="ot">&lt;-</span><span class="fu">summary</span>(mf1)<span class="sc">$</span>coefficient[<span class="dv">2</span>,]</span>
<span id="cb94-7"><a href="time-series-data-analysis-regression.html#cb94-7" aria-hidden="true" tabindex="-1"></a>mf2 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf2d, wsui <span class="sc">~</span> flu <span class="sc">+</span> <span class="fu">ns</span>(ordweek, <span class="dv">22</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx, <span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb94-8"><a href="time-series-data-analysis-regression.html#cb94-8" aria-hidden="true" tabindex="-1"></a>mf2s <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf2d, flu210 <span class="sc">~</span><span class="fu">ns</span>(ordweek, <span class="dv">25</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx,<span class="dv">2</span>), <span class="at">family=</span><span class="fu">quasipoisson</span>())</span>
<span id="cb94-9"><a href="time-series-data-analysis-regression.html#cb94-9" aria-hidden="true" tabindex="-1"></a>f2008<span class="ot">&lt;-</span><span class="fu">summary</span>(mf2)<span class="sc">$</span>coefficient[<span class="dv">2</span>,]</span>
<span id="cb94-10"><a href="time-series-data-analysis-regression.html#cb94-10" aria-hidden="true" tabindex="-1"></a>mfresid<span class="ot">&lt;-</span><span class="fu">c</span>(mf1<span class="sc">$</span>residuals, mf2<span class="sc">$</span>residuals)</span>
<span id="cb94-11"><a href="time-series-data-analysis-regression.html#cb94-11" aria-hidden="true" tabindex="-1"></a>Ch <span class="ot">&lt;-</span><span class="fu">c</span>(myd2<span class="sc">$</span>Change_2008)</span></code></pre></div>
<pre><code>## Warning: Unknown or uninitialised column: `Change_2008`.</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="time-series-data-analysis-regression.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co">#exp(cbind(&quot;Relative Risk&quot;=coef(mf2), confint.default(mf2, level = 0.95)))</span></span>
<span id="cb96-2"><a href="time-series-data-analysis-regression.html#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co">#exp(cbind(&quot;Relative Risk&quot;=coef(mf1), confint.default(mf1, level = 0.95)))</span></span>
<span id="cb96-3"><a href="time-series-data-analysis-regression.html#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="time-series-data-analysis-regression.html#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="time-series-data-analysis-regression.html#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co"># E(Y) = intercept + B1X1 +gam(others)</span></span>
<span id="cb96-6"><a href="time-series-data-analysis-regression.html#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="co"># E(Y)- intercept - B1X1 = gam(otehrs)</span></span>
<span id="cb96-7"><a href="time-series-data-analysis-regression.html#cb96-7" aria-hidden="true" tabindex="-1"></a>gamothers1 <span class="ot">&lt;-</span> mf1<span class="sc">$</span>fitted.values <span class="sc">-</span> <span class="fl">0.943684</span> <span class="sc">-</span>(<span class="sc">-</span><span class="fl">0.013931</span>) <span class="sc">*</span>mf1d<span class="sc">$</span>flu210</span>
<span id="cb96-8"><a href="time-series-data-analysis-regression.html#cb96-8" aria-hidden="true" tabindex="-1"></a>gamothers2 <span class="ot">&lt;-</span> mf2<span class="sc">$</span>fitted.values <span class="sc">-</span> <span class="fl">0.8892468</span> <span class="sc">-</span>(<span class="fl">0.0023323696</span>) <span class="sc">*</span>mf2d<span class="sc">$</span>flu210</span>
<span id="cb96-9"><a href="time-series-data-analysis-regression.html#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="co"># E(Y)- intercept - gam(others)= B1X1  </span></span>
<span id="cb96-10"><a href="time-series-data-analysis-regression.html#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Hence Y axis = E(Y)- intercept - gam(others)</span></span>
<span id="cb96-11"><a href="time-series-data-analysis-regression.html#cb96-11" aria-hidden="true" tabindex="-1"></a>Yaxis.mf1d <span class="ot">&lt;-</span> mf1<span class="sc">$</span>fitted.values <span class="sc">-</span>(<span class="fl">0.943684</span>) <span class="sc">-</span> gamothers1</span>
<span id="cb96-12"><a href="time-series-data-analysis-regression.html#cb96-12" aria-hidden="true" tabindex="-1"></a>Yaxis.mf2d <span class="ot">&lt;-</span> mf2<span class="sc">$</span>fitted.values <span class="sc">-</span>(<span class="fl">0.8892468</span>) <span class="sc">-</span> gamothers2</span>
<span id="cb96-13"><a href="time-series-data-analysis-regression.html#cb96-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-14"><a href="time-series-data-analysis-regression.html#cb96-14" aria-hidden="true" tabindex="-1"></a>mf1d<span class="sc">$</span>Yaxis.mf <span class="ot">&lt;-</span>Yaxis.mf1d</span>
<span id="cb96-15"><a href="time-series-data-analysis-regression.html#cb96-15" aria-hidden="true" tabindex="-1"></a>mf2d<span class="sc">$</span>Yaxis.mf <span class="ot">&lt;-</span>Yaxis.mf2d</span>
<span id="cb96-16"><a href="time-series-data-analysis-regression.html#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mf1d<span class="sc">$</span>flu210, Yaxis.mf1d)</span></code></pre></div>
<p><img src="methods_files/figure-html/ts%20fig%203-1.png" width="672" /></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="time-series-data-analysis-regression.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mf2d<span class="sc">$</span>flu210, Yaxis.mf2d)</span></code></pre></div>
<p><img src="methods_files/figure-html/ts%20fig%203-2.png" width="672" /></p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="time-series-data-analysis-regression.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(myd2<span class="sc">$</span>flu210<span class="sc">*</span><span class="dv">10</span>, myd2<span class="sc">$</span>wsui)</span></code></pre></div>
<p><img src="methods_files/figure-html/ts%20fig%203-3.png" width="672" /></p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="time-series-data-analysis-regression.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(glm(Yaxis.mf1d ~ mf1d$flu210))</span></span>
<span id="cb99-2"><a href="time-series-data-analysis-regression.html#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(glm(Yaxis.mf2d ~ mf2d$flu210))</span></span>
<span id="cb99-3"><a href="time-series-data-analysis-regression.html#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="time-series-data-analysis-regression.html#cb99-4" aria-hidden="true" tabindex="-1"></a>tt <span class="ot">&lt;-</span><span class="fu">c</span>(mf1d<span class="sc">$</span>Yaxis.mf, mf2d<span class="sc">$</span>Yaxis.mf)</span>
<span id="cb99-5"><a href="time-series-data-analysis-regression.html#cb99-5" aria-hidden="true" tabindex="-1"></a>tt2<span class="ot">&lt;-</span><span class="fu">c</span>(mf1<span class="sc">$</span>fitted.values, mf2<span class="sc">$</span>fitted.values)</span>
<span id="cb99-6"><a href="time-series-data-analysis-regression.html#cb99-6" aria-hidden="true" tabindex="-1"></a>myd2 <span class="ot">&lt;-</span>myd2 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Yaxis.mf =</span>tt, <span class="at">mfresid =</span>mfresid, <span class="at">mf.fit=</span>tt2)</span></code></pre></div>
<p>2009년 이후로 좀더 사망하게 되네요.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="time-series-data-analysis-regression.html#cb100-1" aria-hidden="true" tabindex="-1"></a>f3<span class="ot">&lt;-</span><span class="fu">ggplot</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(flu210, Yaxis.mf, <span class="at">col=</span>Change))<span class="sc">+</span><span class="fu">geom_line</span>(<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb100-2"><a href="time-series-data-analysis-regression.html#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(flu210, Yaxis.mf, <span class="at">shape=</span>Change), <span class="at">size=</span><span class="fl">0.0</span>)<span class="sc">+</span></span>
<span id="cb100-3"><a href="time-series-data-analysis-regression.html#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size=</span><span class="dv">14</span>,<span class="at">base_family=</span><span class="st">&#39;Times New Roman&#39;</span>)<span class="sc">+</span> </span>
<span id="cb100-4"><a href="time-series-data-analysis-regression.html#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_blank</span>(), <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>),</span>
<span id="cb100-5"><a href="time-series-data-analysis-regression.html#cb100-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb100-6"><a href="time-series-data-analysis-regression.html#cb100-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>))<span class="sc">+</span></span>
<span id="cb100-7"><a href="time-series-data-analysis-regression.html#cb100-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Influenza&quot;</span>) <span class="sc">+</span><span class="fu">ylab</span>(<span class="st">&quot;Increment of Suicide&quot;</span>)</span>
<span id="cb100-8"><a href="time-series-data-analysis-regression.html#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="time-series-data-analysis-regression.html#cb100-9" aria-hidden="true" tabindex="-1"></a>fig3 <span class="ot">&lt;-</span>f3 <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(flu210, mfresid, <span class="at">shape=</span>Change), <span class="at">size=</span><span class="dv">3</span> ) <span class="sc">+</span></span>
<span id="cb100-10"><a href="time-series-data-analysis-regression.html#cb100-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_shape_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">20</span>))<span class="sc">+</span> <span class="fu">scale_colour_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&#39;red&#39;</span>, <span class="st">&#39;grey45&#39;</span>))<span class="sc">+</span> </span>
<span id="cb100-11"><a href="time-series-data-analysis-regression.html#cb100-11" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;right&quot;</span>) <span class="sc">+</span> </span>
<span id="cb100-12"><a href="time-series-data-analysis-regression.html#cb100-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;Linear relationship between Influenza and Suicide&quot;</span>,</span>
<span id="cb100-13"><a href="time-series-data-analysis-regression.html#cb100-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle=</span><span class="st">&quot;Beta = -0.066, p = 0.214  before 2009</span><span class="sc">\n</span><span class="st">  *RR =  0.013,  p = 0.018     from 2009&quot;</span>) <span class="sc">+</span></span>
<span id="cb100-14"><a href="time-series-data-analysis-regression.html#cb100-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">plot.subtitle=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>, <span class="at">hjust=</span><span class="dv">1</span>, <span class="at">face=</span><span class="st">&quot;italic&quot;</span>, <span class="at">color=</span><span class="st">&quot;black&quot;</span>)) <span class="sc">+</span></span>
<span id="cb100-15"><a href="time-series-data-analysis-regression.html#cb100-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">trans =</span> <span class="st">&#39;log&#39;</span>)</span>
<span id="cb100-16"><a href="time-series-data-analysis-regression.html#cb100-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-17"><a href="time-series-data-analysis-regression.html#cb100-17" aria-hidden="true" tabindex="-1"></a>fig3</span></code></pre></div>
<p><img src="methods_files/figure-html/ts%20fig1.1-1.png" width="672" /></p>
<p>지금까지의 내용을 정리해 보겠습니다.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="time-series-data-analysis-regression.html#cb101-1" aria-hidden="true" tabindex="-1"></a>mf11 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf1d , wsui <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">25</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx,<span class="dv">2</span>))</span>
<span id="cb101-2"><a href="time-series-data-analysis-regression.html#cb101-2" aria-hidden="true" tabindex="-1"></a>mf12 <span class="ot">&lt;-</span><span class="fu">glm</span>(<span class="at">data=</span>mf2d, wsui <span class="sc">~</span> <span class="fu">ns</span>(ordweek, <span class="dv">22</span>)<span class="sc">+</span><span class="fu">ns</span>(sinx, <span class="dv">2</span>)<span class="sc">+</span><span class="fu">ns</span>(cosx, <span class="dv">2</span>))</span>
<span id="cb101-3"><a href="time-series-data-analysis-regression.html#cb101-3" aria-hidden="true" tabindex="-1"></a>tt3<span class="ot">&lt;-</span><span class="fu">c</span>(mf11<span class="sc">$</span>residuals, mf12<span class="sc">$</span>residuals)</span>
<span id="cb101-4"><a href="time-series-data-analysis-regression.html#cb101-4" aria-hidden="true" tabindex="-1"></a>myd2<span class="ot">&lt;-</span>myd2 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">f3resid=</span>tt3) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Period=</span>Change)</span>
<span id="cb101-5"><a href="time-series-data-analysis-regression.html#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="time-series-data-analysis-regression.html#cb101-6" aria-hidden="true" tabindex="-1"></a>f1<span class="ot">&lt;-</span><span class="fu">ggplot</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2, wsui, <span class="at">shape=</span>Change), <span class="at">size=</span><span class="fl">0.3</span>)<span class="sc">+</span> <span class="fu">scale_shape_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">19</span>), <span class="at">name=</span><span class="st">&quot;&quot;</span>)<span class="sc">+</span> </span>
<span id="cb101-7"><a href="time-series-data-analysis-regression.html#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2, wsui, <span class="at">shape=</span>Change))<span class="sc">+</span></span>
<span id="cb101-8"><a href="time-series-data-analysis-regression.html#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#geom_point(aes(x=ymd2, y=f3resid, col=Change)) +</span></span>
<span id="cb101-9"><a href="time-series-data-analysis-regression.html#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2, mod2<span class="sc">$</span>fitted.values, <span class="at">linetype=</span><span class="st">&quot;A&quot;</span>, <span class="at">color=</span><span class="st">&#39;A&#39;</span>))<span class="sc">+</span></span>
<span id="cb101-10"><a href="time-series-data-analysis-regression.html#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2,flu210<span class="sc">*</span><span class="dv">20</span>, <span class="at">linetype=</span><span class="st">&quot;B&quot;</span>, <span class="at">color=</span><span class="st">&#39;B&#39;</span>))<span class="sc">+</span></span>
<span id="cb101-11"><a href="time-series-data-analysis-regression.html#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span>myd2, <span class="fu">aes</span>(ymd2, f3resid, <span class="at">linetype=</span><span class="st">&quot;C&quot;</span>, <span class="at">color=</span><span class="st">&#39;C&#39;</span>))<span class="sc">+</span></span>
<span id="cb101-12"><a href="time-series-data-analysis-regression.html#cb101-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-13"><a href="time-series-data-analysis-regression.html#cb101-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="at">A=</span><span class="st">&quot;dotted&quot;</span>, <span class="at">B=</span><span class="st">&quot;solid&quot;</span>, <span class="at">C=</span><span class="st">&quot;dashed&quot;</span>), </span>
<span id="cb101-14"><a href="time-series-data-analysis-regression.html#cb101-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Suicide (Crude)&quot;</span>, <span class="st">&quot;Influenza like illness&quot;</span>, <span class="st">&quot;Suicide </span><span class="sc">\n</span><span class="st">(Time series adjusted)&quot;</span>), </span>
<span id="cb101-15"><a href="time-series-data-analysis-regression.html#cb101-15" aria-hidden="true" tabindex="-1"></a>                        <span class="at">name=</span><span class="st">&quot;Suicide and Influenza&quot;</span>)<span class="sc">+</span> </span>
<span id="cb101-16"><a href="time-series-data-analysis-regression.html#cb101-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-17"><a href="time-series-data-analysis-regression.html#cb101-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="at">A=</span><span class="st">&quot;black&quot;</span>, <span class="at">B=</span><span class="st">&quot;blue&quot;</span>, <span class="at">C=</span><span class="st">&quot;red&quot;</span>), </span>
<span id="cb101-18"><a href="time-series-data-analysis-regression.html#cb101-18" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Suicide (Crude)&quot;</span>, <span class="st">&quot;Influenza like illness&quot;</span>, <span class="st">&quot;Suicide </span><span class="sc">\n</span><span class="st">(Time series adjusted)&quot;</span>), </span>
<span id="cb101-19"><a href="time-series-data-analysis-regression.html#cb101-19" aria-hidden="true" tabindex="-1"></a>                        <span class="at">name=</span><span class="st">&quot;Suicide and Influenza&quot;</span>)<span class="sc">+</span> </span>
<span id="cb101-20"><a href="time-series-data-analysis-regression.html#cb101-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-21"><a href="time-series-data-analysis-regression.html#cb101-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_blank</span>(), <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>),</span>
<span id="cb101-22"><a href="time-series-data-analysis-regression.html#cb101-22" aria-hidden="true" tabindex="-1"></a>                                                              <span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb101-23"><a href="time-series-data-analysis-regression.html#cb101-23" aria-hidden="true" tabindex="-1"></a>                                                              <span class="at">axis.text.y=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb101-24"><a href="time-series-data-analysis-regression.html#cb101-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Years (unit=weeks)&quot;</span>) <span class="sc">+</span><span class="fu">ylab</span>(<span class="st">&quot;Number of weekly suicide&quot;</span>)</span>
<span id="cb101-25"><a href="time-series-data-analysis-regression.html#cb101-25" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb101-26"><a href="time-series-data-analysis-regression.html#cb101-26" aria-hidden="true" tabindex="-1"></a>  figure1 <span class="ot">&lt;-</span> f1 <span class="sc">+</span></span>
<span id="cb101-27"><a href="time-series-data-analysis-regression.html#cb101-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(ymd2, f3resid), <span class="at">method=</span><span class="st">&#39;gam&#39;</span>, <span class="at">formula=</span>y <span class="sc">~</span><span class="fu">ns</span>(x, <span class="dv">60</span>),</span>
<span id="cb101-28"><a href="time-series-data-analysis-regression.html#cb101-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">se=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>, <span class="at">linetype=</span><span class="st">&quot;solid&quot;</span>, <span class="at">size=</span><span class="fl">0.3</span>, <span class="at">fill =</span> <span class="st">&#39;red&#39;</span>)<span class="sc">+</span></span>
<span id="cb101-29"><a href="time-series-data-analysis-regression.html#cb101-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>( <span class="at">legend.position =</span>   <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> </span>
<span id="cb101-30"><a href="time-series-data-analysis-regression.html#cb101-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">caption =</span><span class="st">&quot;*Beta = weekly suicide number change by % increment of influenza like illness&quot;</span>,</span>
<span id="cb101-31"><a href="time-series-data-analysis-regression.html#cb101-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">title=</span><span class="st">&quot;&quot;</span><span class="co">#, subtitle=&quot;Beta = -0.014, p = 0.158  before 2009\n  Beta =  0.002,  p = 0.011     from 2009&quot;</span></span>
<span id="cb101-32"><a href="time-series-data-analysis-regression.html#cb101-32" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">+</span>   <span class="fu">theme</span>(<span class="at">plot.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">16</span>, <span class="at">hjust=</span><span class="fl">0.5</span>)) <span class="sc">+</span> <span class="co">#face=&quot;italic&quot;, color=&quot;black&quot;))+</span></span>
<span id="cb101-33"><a href="time-series-data-analysis-regression.html#cb101-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb101-34"><a href="time-series-data-analysis-regression.html#cb101-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">sec.axis =</span> <span class="fu">sec_axis</span>((<span class="sc">~</span>.<span class="sc">/</span><span class="dv">20</span>), <span class="at">name=</span><span class="st">&quot;Influenza like illness ( per 100 outpatient )&quot;</span>)) <span class="sc">+</span></span>
<span id="cb101-35"><a href="time-series-data-analysis-regression.html#cb101-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">&#39;2008-09-01&#39;</span>), <span class="at">y =</span> <span class="dv">450</span>, <span class="at">label =</span> <span class="st">&#39;bold(&quot;Before 2009 (  )&quot;)&#39;</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">&#39;A&#39;</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb101-36"><a href="time-series-data-analysis-regression.html#cb101-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">&#39;2008-09-01&#39;</span>), <span class="at">y =</span> <span class="dv">430</span>, <span class="at">label =</span> <span class="st">&#39;italic(&quot;*Beta = -0.066&quot;)&#39;</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">&#39;A&#39;</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb101-37"><a href="time-series-data-analysis-regression.html#cb101-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">&#39;2008-09-01&#39;</span>), <span class="at">y =</span> <span class="dv">410</span>, <span class="at">label =</span> <span class="st">&#39;italic(&quot; p = 0.214&quot;)&#39;</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">&#39;A&#39;</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb101-38"><a href="time-series-data-analysis-regression.html#cb101-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">shape=</span><span class="cn">FALSE</span>)<span class="sc">+</span></span>
<span id="cb101-39"><a href="time-series-data-analysis-regression.html#cb101-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">&#39;2012-01-01&#39;</span>), <span class="at">y =</span> <span class="dv">450</span>, <span class="at">label =</span> <span class="st">&#39;bold(&quot;From  2009 (  )&quot;)&#39;</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">&#39;A&#39;</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb101-40"><a href="time-series-data-analysis-regression.html#cb101-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">&#39;2012-01-01&#39;</span>), <span class="at">y =</span> <span class="dv">430</span>, <span class="at">label =</span> <span class="st">&#39;italic(&quot;*Beta = 0.013&quot;)&#39;</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">&#39;A&#39;</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb101-41"><a href="time-series-data-analysis-regression.html#cb101-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">&#39;2012-01-01&#39;</span>), <span class="at">y =</span> <span class="dv">410</span>, <span class="at">label =</span> <span class="st">&#39;italic(&quot; p = 0.019&quot;)&#39;</span>, <span class="at">parse=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="st">&#39;A&#39;</span>, <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb101-42"><a href="time-series-data-analysis-regression.html#cb101-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">x=</span><span class="fu">as.Date</span>(<span class="st">&#39;2008-06-25&#39;</span>), <span class="at">y=</span><span class="dv">449</span>, <span class="at">size=</span><span class="dv">3</span>, <span class="at">shape=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb101-43"><a href="time-series-data-analysis-regression.html#cb101-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">x=</span><span class="fu">as.Date</span>(<span class="st">&#39;2013-11-01&#39;</span>), <span class="at">y=</span><span class="dv">449</span>, <span class="at">size=</span><span class="dv">3</span>, <span class="at">shape=</span><span class="dv">19</span>) <span class="sc">+</span></span>
<span id="cb101-44"><a href="time-series-data-analysis-regression.html#cb101-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">&#39;2009-01-01&#39;</span>), <span class="at">linetype=</span><span class="st">&quot;dotted&quot;</span>, </span>
<span id="cb101-45"><a href="time-series-data-analysis-regression.html#cb101-45" aria-hidden="true" tabindex="-1"></a>                    <span class="at">color =</span> <span class="st">&quot;grey50&quot;</span>) <span class="co">#+</span></span></code></pre></div>
<pre><code>## Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =
## &quot;none&quot;)` instead.</code></pre>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="time-series-data-analysis-regression.html#cb103-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">#annotate(&quot;rect&quot;, xmin = as.Date(&#39;2004-06-01&#39;), xmax = as.Date(&#39;2009-01-01&#39;),  ymin = -50, ymax = 470,</span></span>
<span id="cb103-2"><a href="time-series-data-analysis-regression.html#cb103-2" aria-hidden="true" tabindex="-1"></a>     <span class="co">#       alpha = .1)</span></span>
<span id="cb103-3"><a href="time-series-data-analysis-regression.html#cb103-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-4"><a href="time-series-data-analysis-regression.html#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="time-series-data-analysis-regression.html#cb103-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb103-6"><a href="time-series-data-analysis-regression.html#cb103-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-7"><a href="time-series-data-analysis-regression.html#cb103-7" aria-hidden="true" tabindex="-1"></a>  figure1 </span></code></pre></div>
<p><img src="methods_files/figure-html/ts%20fig12-1.png" width="1152" /></p>
<p>여기 까지 실습하시느라 수고하셨습니다. 상기 분석 방법으로 아래 논문을 출판하였습니다. 참고해서 보시면 좋겠습니다. <a href="https://journals.plos.org/plosone/article/comments?id=10.1371/journal.pone.0244596" class="uri">https://journals.plos.org/plosone/article/comments?id=10.1371/journal.pone.0244596</a></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="직업병-연구방법론.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="nested-case-control-study.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["methods.pdf", "methods.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
